create schema distribute_stat;
create schema distribute_stat2;
set current_schema = distribute_stat;
create table test_analyze(f1 int, f2 float, f3 text);
insert into test_analyze select generate_series(1,1000), 10.0, repeat('Gauss Database,Niubility!!',2);
analyze test_analyze;
select relpages > 0 as relpagesgtzero,reltuples > 0 as reltuplesgtzero from pg_class where relname = 'test_analyze';
 relpagesgtzero | reltuplesgtzero 
----------------+-----------------
 t              | t
(1 row)

select starelkind,staattnum,stainherit,stanullfrac,stawidth,stadistinct,stakind1,stakind2,stakind3,stakind4,stakind5,staop1,staop2,staop3
,staop4,staop5,stanumbers1,stanumbers3,stanumbers4,stanumbers5
 from pg_statistic sta join pg_class cla on sta.starelid=cla.oid where relname = 'test_analyze' order by staattnum;
 starelkind | staattnum | stainherit | stanullfrac | stawidth | stadistinct | stakind1 | stakind2 | stakind3 | stakind4 | stakind5 | staop1 | staop2 | staop3 | staop4 | staop5 | stanumbers1 | stanumbers3 | stanumbers4 | stanumbers5 
------------+-----------+------------+-------------+----------+-------------+----------+----------+----------+----------+----------+--------+--------+--------+--------+--------+-------------+-------------+-------------+-------------
 c          |         1 | f          |           0 |        4 |          -1 |        2 |        3 |        0 |        0 |        0 |     97 |     97 |      0 |      0 |      0 |             |             |             | 
 c          |         2 | f          |           0 |        8 |           1 |        1 |        3 |        0 |        0 |        0 |    670 |    672 |      0 |      0 |      0 | {1}         |             |             | 
 c          |         3 | f          |           0 |       53 |           1 |        1 |        3 |        0 |        0 |        0 |     98 |    664 |      0 |      0 |      0 | {1}         |             |             | 
(3 rows)

analyze verbose test_analyze;
--?INFO:  analyzing "distribute_stat.test_analyze".*
--?INFO:  ANALYZE INFO : "test_analyze".*
select relpages > 0 as relpagesgtzero,reltuples > 0 as reltuplesgtzero from pg_class where relname = 'test_analyze';
 relpagesgtzero | reltuplesgtzero 
----------------+-----------------
 t              | t
(1 row)

select starelkind,staattnum,stainherit,stanullfrac,stawidth,stadistinct,stakind1,stakind2,stakind3,stakind4,stakind5,staop1,staop2,staop3
,staop4,staop5,stanumbers1,stanumbers3,stanumbers4,stanumbers5
 from pg_statistic sta join pg_class cla on sta.starelid=cla.oid where relname = 'test_analyze' order by staattnum;
 starelkind | staattnum | stainherit | stanullfrac | stawidth | stadistinct | stakind1 | stakind2 | stakind3 | stakind4 | stakind5 | staop1 | staop2 | staop3 | staop4 | staop5 | stanumbers1 | stanumbers3 | stanumbers4 | stanumbers5 
------------+-----------+------------+-------------+----------+-------------+----------+----------+----------+----------+----------+--------+--------+--------+--------+--------+-------------+-------------+-------------+-------------
 c          |         1 | f          |           0 |        4 |          -1 |        2 |        3 |        0 |        0 |        0 |     97 |     97 |      0 |      0 |      0 |             |             |             | 
 c          |         2 | f          |           0 |        8 |           1 |        1 |        3 |        0 |        0 |        0 |    670 |    672 |      0 |      0 |      0 | {1}         |             |             | 
 c          |         3 | f          |           0 |       53 |           1 |        1 |        3 |        0 |        0 |        0 |     98 |    664 |      0 |      0 |      0 | {1}         |             |             | 
(3 rows)

--test analyze column
delete from pg_statistic where exists(select 1 from pg_class where  oid=starelid and relname = 'test_analyze');
analyze test_analyze(f2,f1);
select relpages > 0 as relpagesgtzero,reltuples > 0 as reltuplesgtzero from pg_class where relname = 'test_analyze';
 relpagesgtzero | reltuplesgtzero 
----------------+-----------------
 t              | t
(1 row)

select starelkind,staattnum,stainherit,stanullfrac,stawidth,stadistinct,stakind1,stakind2,stakind3,stakind4,stakind5,staop1,staop2,staop3
,staop4,staop5,stanumbers1,stanumbers3,stanumbers4,stanumbers5
 from pg_statistic sta join pg_class cla on sta.starelid=cla.oid where relname = 'test_analyze' order by staattnum;
 starelkind | staattnum | stainherit | stanullfrac | stawidth | stadistinct | stakind1 | stakind2 | stakind3 | stakind4 | stakind5 | staop1 | staop2 | staop3 | staop4 | staop5 | stanumbers1 | stanumbers3 | stanumbers4 | stanumbers5 
------------+-----------+------------+-------------+----------+-------------+----------+----------+----------+----------+----------+--------+--------+--------+--------+--------+-------------+-------------+-------------+-------------
 c          |         1 | f          |           0 |        4 |          -1 |        2 |        3 |        0 |        0 |        0 |     97 |     97 |      0 |      0 |      0 |             |             |             | 
 c          |         2 | f          |           0 |        8 |           1 |        1 |        3 |        0 |        0 |        0 |    670 |    672 |      0 |      0 |      0 | {1}         |             |             | 
(2 rows)

delete from pg_statistic where exists(select 1 from pg_class where  oid=starelid and relname = 'test_analyze');
analyze test_analyze(f1,f1);
select starelkind,staattnum,stainherit,stanullfrac,stawidth,stadistinct,stakind1,stakind2,stakind3,stakind4,stakind5,staop1,staop2,staop3
,staop4,staop5,stanumbers1,stanumbers3,stanumbers4,stanumbers5
 from pg_statistic sta join pg_class cla on sta.starelid=cla.oid where relname = 'test_analyze' order by staattnum;
 starelkind | staattnum | stainherit | stanullfrac | stawidth | stadistinct | stakind1 | stakind2 | stakind3 | stakind4 | stakind5 | staop1 | staop2 | staop3 | staop4 | staop5 | stanumbers1 | stanumbers3 | stanumbers4 | stanumbers5 
------------+-----------+------------+-------------+----------+-------------+----------+----------+----------+----------+----------+--------+--------+--------+--------+--------+-------------+-------------+-------------+-------------
 c          |         1 | f          |           0 |        4 |          -1 |        2 |        3 |        0 |        0 |        0 |     97 |     97 |      0 |      0 |      0 |             |             |             | 
(1 row)

select count(distinct f1) from test_analyze;
 count 
-------
  1000
(1 row)

---test for null table
delete from test_analyze;
analyze test_analyze;
select relpages > 0 as relpagesgtzero,reltuples > 0 as reltuplesgtzero from pg_class where relname = 'test_analyze';
 relpagesgtzero | reltuplesgtzero 
----------------+-----------------
 t              | f
(1 row)

select staattnum,stanullfrac,stadistinct from pg_statistic sta join pg_class cla on sta.starelid=cla.oid where relname = 'test_analyze' order by staattnum;
 staattnum | stanullfrac | stadistinct 
-----------+-------------+-------------
         1 |           0 |          -1
(1 row)

---test for nullfrac
insert into test_analyze select generate_series(1,1000), 10.0, null;
delete from pg_statistic where exists(select 1 from pg_class where  oid=starelid and relname = 'test_analyze');
analyze test_analyze(f3);
select staattnum,stanullfrac,stadistinct from pg_statistic sta join pg_class cla on sta.starelid=cla.oid where relname = 'test_analyze' order by staattnum;
 staattnum | stanullfrac | stadistinct 
-----------+-------------+-------------
         3 |           1 |           0
(1 row)

select count(distinct f3) from test_analyze;
 count 
-------
     0
(1 row)

create unique index test_analyze_index on test_analyze(f1);
vacuum analyze test_analyze;
select relpages > 0 as relpagesgtzero,reltuples > 0 as reltuplesgtzero from pg_class where relname = 'test_analyze_index';
 relpagesgtzero | reltuplesgtzero 
----------------+-----------------
 t              | t
(1 row)

select starelkind,staattnum,stainherit,stanullfrac,stawidth,stadistinct,stakind1,stakind2,stakind3,stakind4,stakind5,staop1,staop2,staop3
,staop4,staop5,stanumbers1,stanumbers2,stanumbers3,stanumbers4,stanumbers5
 from pg_statistic sta join pg_class cla on sta.starelid=cla.oid where relname = 'test_analyze_index' order by staattnum;
 starelkind | staattnum | stainherit | stanullfrac | stawidth | stadistinct | stakind1 | stakind2 | stakind3 | stakind4 | stakind5 | staop1 | staop2 | staop3 | staop4 | staop5 | stanumbers1 | stanumbers2 | stanumbers3 | stanumbers4 | stanumbers5 
------------+-----------+------------+-------------+----------+-------------+----------+----------+----------+----------+----------+--------+--------+--------+--------+--------+-------------+-------------+-------------+-------------+-------------
(0 rows)

delete from pg_statistic where exists(select 1 from pg_class where  oid=starelid and relname = 'test_analyze');
vacuum analyze public.test_analyze;
ERROR:  relation "public.test_analyze" does not exist
select starelkind,staattnum,stainherit,stanullfrac,stawidth,stadistinct,stakind1,stakind2,stakind3,stakind4,stakind5,staop1,staop2,staop3
,staop4,staop5,stanumbers1,stanumbers2,stanumbers3,stanumbers4,stanumbers5
 from pg_statistic sta join pg_class cla on sta.starelid=cla.oid where relname = 'test_analyze' order by staattnum;
 starelkind | staattnum | stainherit | stanullfrac | stawidth | stadistinct | stakind1 | stakind2 | stakind3 | stakind4 | stakind5 | staop1 | staop2 | staop3 | staop4 | staop5 | stanumbers1 | stanumbers2 | stanumbers3 | stanumbers4 | stanumbers5 
------------+-----------+------------+-------------+----------+-------------+----------+----------+----------+----------+----------+--------+--------+--------+--------+--------+-------------+-------------+-------------+-------------+-------------
(0 rows)

--test for ORIENTATION COLUMN
create table test_analyze_col(f1 bigint, f2 int, f3 char(10)) WITH (ORIENTATION = COLUMN) ;
insert into test_analyze_col select generate_series(1,1000), generate_series(1,1000), 'col'|| generate_series(1,1000);
select relpages > 0 as relpagesgtzero,reltuples > 0 as reltuplesgtzero from pg_class where relname = 'test_analyze_col';
 relpagesgtzero | reltuplesgtzero 
----------------+-----------------
 f              | f
(1 row)

select starelkind,staattnum,stainherit,stanullfrac,stawidth,stadistinct,stakind1,stakind2,stakind3,stakind4,stakind5,staop1,staop2,staop3
,staop4,staop5,stanumbers1,stanumbers3,stanumbers4,stanumbers5
 from pg_statistic sta join pg_class cla on sta.starelid=cla.oid where relname = 'test_analyze_col' order by staattnum;
 starelkind | staattnum | stainherit | stanullfrac | stawidth | stadistinct | stakind1 | stakind2 | stakind3 | stakind4 | stakind5 | staop1 | staop2 | staop3 | staop4 | staop5 | stanumbers1 | stanumbers3 | stanumbers4 | stanumbers5 
------------+-----------+------------+-------------+----------+-------------+----------+----------+----------+----------+----------+--------+--------+--------+--------+--------+-------------+-------------+-------------+-------------
(0 rows)

analyze test_analyze_col(f2,f1);
select relpages > 0 as relpagesgtzero,reltuples > 0 as reltuplesgtzero from pg_class where relname = 'test_analyze_col';
 relpagesgtzero | reltuplesgtzero 
----------------+-----------------
 t              | t
(1 row)

select starelkind,staattnum,stainherit,stanullfrac,stawidth,stadistinct,stakind1,stakind2,stakind3,stakind4,stakind5,staop1,staop2,staop3
,staop4,staop5,stanumbers1,stanumbers3,stanumbers4,stanumbers5
 from pg_statistic sta join pg_class cla on sta.starelid=cla.oid where relname = 'test_analyze_col' order by staattnum;
 starelkind | staattnum | stainherit | stanullfrac | stawidth | stadistinct | stakind1 | stakind2 | stakind3 | stakind4 | stakind5 | staop1 | staop2 | staop3 | staop4 | staop5 | stanumbers1 | stanumbers3 | stanumbers4 | stanumbers5 
------------+-----------+------------+-------------+----------+-------------+----------+----------+----------+----------+----------+--------+--------+--------+--------+--------+-------------+-------------+-------------+-------------
 c          |         1 | f          |           0 |        8 |          -1 |        2 |        3 |        0 |        0 |        0 |    412 |    412 |      0 |      0 |      0 |             |             |             | 
 c          |         2 | f          |           0 |        4 |          -1 |        2 |        3 |        0 |        0 |        0 |     97 |     97 |      0 |      0 |      0 |             |             |             | 
(2 rows)

delete from pg_statistic where exists(select 1 from pg_class where  oid=starelid and relname = 'test_analyze_col');
analyze verbose test_analyze_col;
--?INFO:  analyzing "distribute_stat.test_analyze_col".*
--?INFO:  ANALYZE INFO.*
--?INFO:  ANALYZE INFO.*
select relpages > 0 as relpagesgtzero,reltuples > 0 as reltuplesgtzero from pg_class where relname = 'test_analyze_col';
 relpagesgtzero | reltuplesgtzero 
----------------+-----------------
 t              | t
(1 row)

select starelkind,staattnum,stainherit,stanullfrac,stawidth,stadistinct,stakind1,stakind2,stakind3,stakind4,stakind5,staop1,staop2,staop3
,staop4,staop5,stanumbers1,stanumbers3,stanumbers4,stanumbers5
 from pg_statistic sta join pg_class cla on sta.starelid=cla.oid where relname = 'test_analyze_col' order by staattnum;
 starelkind | staattnum | stainherit | stanullfrac | stawidth | stadistinct | stakind1 | stakind2 | stakind3 | stakind4 | stakind5 | staop1 | staop2 | staop3 | staop4 | staop5 | stanumbers1 | stanumbers3 | stanumbers4 | stanumbers5 
------------+-----------+------------+-------------+----------+-------------+----------+----------+----------+----------+----------+--------+--------+--------+--------+--------+-------------+-------------+-------------+-------------
 c          |         1 | f          |           0 |        8 |          -1 |        2 |        3 |        0 |        0 |        0 |    412 |    412 |      0 |      0 |      0 |             |             |             | 
 c          |         2 | f          |           0 |        4 |          -1 |        2 |        3 |        0 |        0 |        0 |     97 |     97 |      0 |      0 |      0 |             |             |             | 
 c          |         3 | f          |           0 |       11 |          -1 |        2 |        3 |        0 |        0 |        0 |   1058 |   1058 |      0 |      0 |      0 |             |             |             | 
(3 rows)

set default_statistics_target=0;
analyze test_analyze_col;
reset default_statistics_target;
analyze test_analyze_col;
truncate table test_analyze_col;
vacuum full test_analyze_col;
delete from test_analyze_col;
analyze test_analyze_col;
select starelkind,staattnum,stainherit,stanullfrac,stawidth,stadistinct,stakind1,stakind2,stakind3,stakind4,stakind5,staop1,staop2,staop3
,staop4,staop5,stanumbers1,stanumbers3,stanumbers4,stanumbers5
 from pg_statistic sta join pg_class cla on sta.starelid=cla.oid where relname = 'test_analyze_col' order by staattnum;
 starelkind | staattnum | stainherit | stanullfrac | stawidth | stadistinct | stakind1 | stakind2 | stakind3 | stakind4 | stakind5 | staop1 | staop2 | staop3 | staop4 | staop5 | stanumbers1 | stanumbers3 | stanumbers4 | stanumbers5 
------------+-----------+------------+-------------+----------+-------------+----------+----------+----------+----------+----------+--------+--------+--------+--------+--------+-------------+-------------+-------------+-------------
 c          |         1 | f          |           0 |        8 |          -1 |        2 |        3 |        0 |        0 |        0 |    412 |    412 |      0 |      0 |      0 |             |             |             | 
 c          |         2 | f          |           0 |        4 |          -1 |        2 |        3 |        0 |        0 |        0 |     97 |     97 |      0 |      0 |      0 |             |             |             | 
 c          |         3 | f          |           0 |       11 |          -1 |        2 |        3 |        0 |        0 |        0 |   1058 |   1058 |      0 |      0 |      0 |             |             |             | 
(3 rows)

create index test_i on test_analyze_col(f1);
analyze test_analyze_col(f2);
reset current_schema; 
drop schema distribute_stat cascade;
NOTICE:  drop cascades to 2 other objects
DETAIL:  drop cascades to table distribute_stat.test_analyze
drop cascades to table distribute_stat.test_analyze_col
drop schema distribute_stat2 cascade;
