/*
 * This file is used to test the function of hashagg with LLVM Optimization
 */
----
--- Create Table and Insert Data
----
drop schema if exists llvm_vecagg_engine3 cascade;
NOTICE:  schema "llvm_vecagg_engine3" does not exist, skipping
create schema llvm_vecagg_engine3;
set current_schema = llvm_vecagg_engine3;
set codegen_cost_threshold=0;
CREATE TABLE llvm_vecagg_engine3.LLVM_VECAGG_TABLE_03(
    col_int	int,
    col_bint	bigint,
    col_vchar1	varchar(7),
    col_vchar2	varchar(16),
    col_num1	numeric(17,5),
    col_num2	numeric(18,0),
    col_num3	numeric(18,2),
    col_num4	numeric(19,4)
)with(orientation=column);
copy llvm_vecagg_table_03 from stdin;
analyze llvm_vecagg_table_03;
----
--- test1 : test build hash table with date, timestamp, char, varchar
----
--- group by having
select col_bint, col_int from llvm_vecagg_table_03 group by col_bint, col_int having sum((-1.20000)) <= -1 order by 1, 2;
 col_bint | col_int 
----------+---------
     -458 |       2
     -345 |       2
        4 |     -56
        7 |     458
        8 |      36
       87 |      52
      123 |       1
      258 |       1
      548 |        
     4875 |    6985
     6987 |       2
     8759 |       6
     9875 |       2
    69857 |     -74
    87549 |       2
   698754 |       2
  2587963 |       1
  9223372 |      67
          |       8
          |      25
(20 rows)

select col_bint from llvm_vecagg_table_03 group by col_bint having sum(col_num1) > 25836.98 order by 1;
 col_bint 
----------
     -458
        4
        8
      258
     4875
    87549
  2587963
(7 rows)

----
--- test2 : test sum(numeric) & avg(numeric) with change
----
select sum(col_bint), sum(col_num1), sum(col_num2) from llvm_vecagg_table_03 group by col_int order by 1, 2, 3;
   sum   |         sum         |         sum          
---------+---------------------+----------------------
       4 |         56987.25600 |   222337203685475805
       7 |             7.25412 |                     
       8 |         98125.87589 |          12233720368
      87 |                     |                     
     548 |             0.00000 |                    0
    4875 |    4587962145.36000 |   922337203685473807
    8759 |             0.00000 |                    0
   69857 |             3.60000 |                   -1
  802362 | -774012907568.40348 | -1857092405402533899
 2588344 |  383890850025.15523 |  1058977794078099369
 9223372 |        -15478.25600 |   223372036854775806
         |             0.00000 |                   -2
         |              .10000 |                    1
(13 rows)

select sum(col_num3), avg(col_num4) from llvm_vecagg_table_03 group by col_vchar2 order by 1, 2;
         sum          |            avg             
----------------------+----------------------------
 -1846050737075516.12 |      -115000000000000.0000
 -1000000000000000.00 |       -15420000000000.0000
            -19516.09 |      -227686642042841.8753
                 -.09 | -.000050000000000000000000
                18.02 |       180.2600000000000000
                41.02 |        13.1782000000000000
            248979.61 |       -77100000000770.1907
  1000000000000000.01 |       100000000000000.0001
  2223372036854775.04 |       399223372036853.9801
  2233720368547758.05 |       922337203685477.5805
  9223372036854775.04 |        99611686018416.8401
(11 rows)

select avg(col_num2), sum(col_num4), col_int from llvm_vecagg_table_03 group by col_int, col_vchar1 order by 3, 1;
           avg           |          sum          | col_int 
-------------------------+-----------------------+---------
 -1.00000000000000000000 |                       |     -74
      222337203685475805 |  -15420000000000.0000 |     -56
      117802878611661782 | 1321560575722331.5606 |       1
      823372036854775805 |  199223372036853.7801 |       1
     -472802878611661780 | -260975422905750.4290 |       2
     -461860174089605170 | -908758856718750.4290 |       2
   -20368547758.00000000 |              258.1425 |       2
  12233720368547758.0000 |   28987711452875.2145 |       2
  0.00000000000000000000 |                0.0000 |       6
  1.00000000000000000000 |                6.3564 |       8
     -2.0000000000000000 |              -20.1000 |      25
    12233720368.00000000 |  100000000000000.0001 |      36
                         |               20.0000 |      52
      223372036854775806 | -154200000000000.3600 |      67
                         |              180.2600 |     458
      922337203685473807 |            -1540.0214 |    6985
  0.00000000000000000000 |                -.0001 |        
(17 rows)

select avg(col_num4), avg(col_num3), col_int from llvm_vecagg_table_03 group by col_int order by 1, 2;
            avg             |          avg           | col_int 
----------------------------+------------------------+---------
      -190124428028561.2502 |  -307675122849172.0350 |       2
      -154200000000000.3600 |    256874.360000000000 |      67
       -15420000000000.0000 | -1000000000000000.0000 |     -56
     -1540.0214000000000000 | -7895.0000000000000000 |    6985
       -20.1000000000000000 |                        |      25
 -.000100000000000000000000 |  .01000000000000000000 |        
     0.00000000000000000000 | -.10000000000000000000 |       6
         6.3564000000000000 |  .02000000000000000000 |       8
        20.0000000000000000 |    41.0000000000000000 |      52
       180.2600000000000000 |    18.0200000000000000 |     458
       100000000000000.0001 |  1000000000000000.0100 |      36
       506927982586395.1136 |  4560154814085769.3767 |       1
                            |  .25000000000000000000 |     -74
(13 rows)

select sum(col_num2), sum(col_num3), sum(col_num4) from llvm_vecagg_table_03 group by col_int, col_vchar2 order by 1, 2, 3;
         sum          |         sum          |          sum          
----------------------+----------------------+-----------------------
 -1847092405402533899 |            -19516.09 | -910746568171367.5010
   -10000000000000000 | -1846050737075516.12 | -230000000000000.0000
                   -2 |                      |              -20.1000
                   -1 |                  .25 |                      
                    0 |                 -.10 |                0.0000
                    0 |                  .01 |                -.0001
                    1 |                  .02 |                6.3564
          12233720368 |  1000000000000000.01 |  100000000000000.0001
    12233720368547758 |  2223372036854775.04 |  399223372036853.9801
   222337203685475805 | -1000000000000000.00 |  -15420000000000.0000
   223372036854775806 |            256874.36 | -154200000000000.3600
   223372036854775806 |  2233720368547758.05 |  922337203685477.5805
   823372036854775805 |  9223372036854775.04 |  199223372036853.7801
   922337203685473807 |             -7895.00 |            -1540.0214
                      |                18.02 |              180.2600
                      |                41.00 |               20.0000
(16 rows)

select avg(col_num1), sum(col_num2) from llvm_vecagg_table_03 group by col_vchar1, col_vchar2 order by 1, 2;
           avg           |         sum         
-------------------------+---------------------
  -360287970189.63968000 | -923720348179210340
  -260287970189.63968000 | -923372036854775801
   -26028797018.00000000 |  -22233720368547758
 -15478.2560000000000000 |  223372036854775806
  0.00000000000000000000 |                  -2
  0.00000000000000000000 |                   0
  0.00000000000000000000 |                   0
   .10000000000000000000 |                   1
      3.6000000000000000 |                  -1
      7.2541200000000000 |                    
    125.8758900000000000 |  223372036854775806
      56987.256000000000 |  222337203685475805
      98125.875890000000 |        -20368547758
      98125.875890000000 |         12233720368
     4587962145.36000000 |  922337203685473807
    23602879709.63967000 |   12233720368547758
   232879701892.63967000 |   12233720368547758
   360287970189.63967000 |  823372036854775805
                         |                    
(19 rows)

select avg(col_num4 * 2.005), sum(col_num2  + col_num3), col_vchar1, col_vchar2 from llvm_vecagg_table_03 group by col_vchar1, col_vchar2 order by 1, 2, 3, 4;
           avg            |          sum           | col_vchar1 |    col_vchar2    
--------------------------+------------------------+------------+------------------
 -911030753860547.3050725 | -923720348179229856.10 | Know       | youhaveyourheart
 -519270361463014.8050725 |  -23157440737095516.06 | beword     | youhaveyourpan
 -309171000000000.7218000 |  223372036855032680.36 | sweet      | keepin body
  -30917100000000.0000000 |  221337203685475805.00 | sweet      | keepin mind 
   -3985361463014.8050725 | -923372036854785559.04 | beword     | youhaveyourheart
   -3087.7429070000000000 |  922337203685465912.00 | people     | keepin body
     -40.3005000000000000 |                        |            | Youhavemyheartwo
   -.00020050000000000000 |                    .01 |            | letsgo
   0.00000000000000000000 |                   -.10 | people     | letsgo
      12.7445820000000000 |                   1.02 | kindle     | 
      40.1000000000000000 |                        | people     | 
     361.4213000000000000 |                        | kindle     | keep
     517.5757125000000000 |        -20368537999.95 | be far     | youhaveyourheart
   58120361463014.8050725 |   11311390000019999.94 | know       | youhaveyourpan
  200500000000000.0002005 |    1000012233720368.01 | know       | justforfun
  399442860933891.8291005 |  832595408891630580.04 | be far     | Youhavemyheartwo
  800442860933892.2301005 |   14457092405402533.04 | I know     | Youhavemyheartfi
 1849286093389382.5489025 |  225605757223323564.05 | I know     | Youhavemyheartfo
                          |                   -.75 | kindle     | keepin body
(19 rows)

select sum(col_num2 -(-200000.005)), sum(col_num4  + col_num3), col_vchar1, col_vchar2 from llvm_vecagg_table_03 group by col_vchar1, col_vchar2 order by 1, 2;
           sum           |          sum           | col_vchar1 |    col_vchar2    
-------------------------+------------------------+------------+------------------
 -923720348178810339.990 |  -908758856738266.5290 | Know       | youhaveyourheart
 -923372036854575800.995 |    -1987711462633.2545 | beword     | youhaveyourheart
  -22233720368347757.995 | -1182708080000633.2745 | beword     | youhaveyourpan
        -20368347757.995 |             10016.1925 | be far     | youhaveyourheart
              199998.005 |                        |            | Youhavemyheartwo
              199999.005 |                        | kindle     | keepin body
              200000.005 |                 -.1000 | people     | letsgo
              200000.005 |                  .0099 |            | letsgo
              200001.005 |                 6.3764 | kindle     | 
         12233920368.005 |  1100000000000000.0101 | know       | justforfun
   12233720368747758.005 |  -893342657074882.8455 | know       | youhaveyourpan
   12233720368747758.005 |  2622595408891629.0201 | I know     | Youhavemyheartfi
  222337203685675805.005 | -1015420000000000.0000 | sweet      | keepin mind 
  223372036854975806.005 |  -154199999743126.0000 | sweet      | keepin body
  223372036854975806.005 |  3156057572233235.6305 | I know     | Youhavemyheartfo
  823372036854975805.005 |  9422595408891628.8201 | be far     | Youhavemyheartwo
  922337203685673807.005 |             -9435.0214 | people     | keepin body
                         |                61.0000 | people     | 
                         |               198.2800 | kindle     | keep
(19 rows)

select sum(col_num4 -(-200000.005) + col_num1), avg(col_num1 * 2 + col_num4  - col_num3), col_int from llvm_vecagg_table_03 group by col_int order by 1, 2, 3;
           sum           |           avg           | col_int 
-------------------------+-------------------------+---------
 -1141520579878935.87448 |   117292690518087.98367 |       2
  -154199999815478.61100 |  -154200000287831.23200 |      67
   -15419999743012.73900 |   984580000113974.51200 |     -56
            199979.90500 |                         |      25
            200000.00490 |  -.01010000000000000000 |        
            200000.00500 |   .10000000000000000000 |       6
            200006.46140 |      6.5364000000000000 |       8
            200187.51912 |    176.7482400000000000 |     458
        4588160605.34360 |     9175930645.69860000 |    6985
   100000000298125.88099 |  -899999999803748.25812 |      36
  1521167839209210.51093 | -4052970904266024.15961 |       1
                         |                         |     -74
                         |                         |      52
(13 rows)

----
--- test4 : test print hash conflict case
----
set analysis_options="on(HASH_CONFLICT)";
select sum(col_num3), avg(col_num3-(-0.25)) from llvm_vecagg_table_03 group by col_int order by 1, 2;
         sum          |          avg           
----------------------+------------------------
 -1846050737095032.21 |  -307675122849171.7850
 -1000000000000000.00 |  -999999999999999.7500
             -7895.00 | -7894.7500000000000000
                 -.10 |  .15000000000000000000
                  .01 |  .26000000000000000000
                  .02 |  .27000000000000000000
                  .25 |  .50000000000000000000
                18.02 |    18.2700000000000000
                41.00 |    41.2500000000000000
            256874.36 |    256874.610000000000
  1000000000000000.01 |  1000000000000000.2600
 13680464442257308.13 |  4560154814085769.6267
                      |                       
(13 rows)

reset analysis_options;
----
--- test5 : test distinct in aggregate functions
----
select col_int, max(distinct col_num1 order by col_num1), min(col_num2 order by col_num2) from llvm_vecagg_table_03 group by col_int order by 1, 2, 3;
 col_int |        max         |         min         
---------+--------------------+---------------------
     -74 |            3.60000 |                  -1
     -56 |        56987.25600 |  222337203685475805
       1 | 360287970189.63967 |   12233720368547758
       2 | 232879701892.63967 | -923720368547758098
       6 |            0.00000 |                   0
       8 |             .10000 |                   1
      25 |            0.00000 |                  -2
      36 |        98125.87589 |         12233720368
      52 |                    |                    
      67 |       -15478.25600 |  223372036854775806
     458 |            7.25412 |                    
    6985 |   4587962145.36000 |  922337203685473807
         |            0.00000 |                   0
(13 rows)

----
--- clean table and resource
----
drop schema llvm_vecagg_engine3 cascade;
NOTICE:  drop cascades to table llvm_vecagg_table_03
