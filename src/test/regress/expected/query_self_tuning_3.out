\c postgres
create schema sql_self_tuning_3;
set current_schema='sql_self_tuning_3';
set resource_track_duration=0;
set resource_track_cost=30;
set resource_track_level=operator;
/*
 * SQL-Self Tuning scenario[6] statistic not collect
 * operator mode should report both operator/query level issues
 */
create table t61(c1 int, c2 int, c3 int);
create table t62(c1 int, c2 int, c3 int);
create table t63(c1 int, c2 int, c3 int);
update pg_class set reltuples = 90000000000 where relname = 't63';
set resource_track_level=query;
/* Test statistics not collect query level */ select count(*), t62.c1 from t61 join t62 on t61.c2 = t62.c2 group by 2;
 count | c1 
-------+----
(0 rows)

/* Test statistics not collect query level */ select count(*), t63.c1 from t61 join t63 on t61.c2 = t63.c2 group by 2;
 count | c1 
-------+----
(0 rows)

select query, query_plan, warning from pgxc_wlm_session_history where query like '%Test statistics not collect%' order by 1;
                                                         query                                                          |                                                  query_plan                                                   |             warning              
------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------+----------------------------------
--? /\* Test statistics not collect query level \*/ select count(\*), t62.c1 from t61 join t62 on t61.c2 = t62.c2 group by 2; |  1 | Streaming (type: GATHER)  (.*)                                         +| Statistic Not Collect:          +
--?                                                                                                                        |  2 |  ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)                      +|     sql_self_tuning_3.t61(c1,c2)+
--?                                                                                                                        |  3 |   ->  HashAggregate  (.*)                                              +|     sql_self_tuning_3.t62(c1,c2)+
                                                                                                                        |    |    Group By Key: t62.c1                                                                                 +| 
--?                                                                                                                        |  4 |    ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*)               +| 
--?                                                                                                                        |  5 |     ->  Hash Join  (.*)                                                 +| 
                                                                                                                        |    |      Hash Cond: (t61.c2 = t62.c2)                                                                       +| 
--?                                                                                                                        |  6 |      ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*)              +| 
--?                                                                                                                        |  7 |       ->  Seq Scan on t61  (.*)                                          +| 
--?                                                                                                                        |  8 |      ->  Hash  (.*)                                                     +| 
--?                                                                                                                        |  9 |       ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*)             +| 
--?                                                                                                                        | 10 |        ->  Seq Scan on t62  (.*)                                          | 
--? /\* Test statistics not collect query level \*/ select count(\*), t63.c1 from t61 join t63 on t61.c2 = t63.c2 group by 2; |  1 | Streaming (type: GATHER)  (.*)                           +| Statistic Not Collect:          +
--?                                                                                                                        |  2 |  ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)        +|     sql_self_tuning_3.t61(c1,c2)+
--?                                                                                                                        |  3 |   ->  HashAggregate  (.*)                                +| 
                                                                                                                        |    |    Group By Key: t63.c1                                                                                 +| 
--?                                                                                                                        |  4 |    ->  Streaming(type: LOCAL REDISTRIBUTE dop: 2/2)  (.*)+| 
--?                                                                                                                        |  5 |     ->  HashAggregate  (.*)                              +| 
                                                                                                                        |    |      Group By Key: t63.c1                                                                               +| 
--?                                                                                                                        |  6 |      ->  Hash Join  (.*)                                 +| 
                                                                                                                        |    |       Hash Cond: (t63.c2 = t61.c2)                                                                      +| 
--?                                                                                                                        |  7 |       ->  Seq Scan on t63  (.*)                            +| 
--?                                                                                                                        |  8 |       ->  Hash  (.*)                                                   +| 
--?                                                                                                                        |  9 |        ->  Streaming(type: SPLIT BROADCAST dop: 2/2)  (.*)              +| 
--?                                                                                                                        | 10 |         ->  Seq Scan on t61  (.*)                                         | 
(2 rows)

set resource_track_level=operator;
/* Test statistics not collect operator level */ select count(*), t62.c1 from t61 join t62 on t61.c2 = t62.c2 group by 2;
 count | c1 
-------+----
(0 rows)

/* Test statistics not collect operator level */ select count(*), t63.c1 from t61 join t63 on t61.c2 = t63.c2 group by 2;
 count | c1 
-------+----
(0 rows)

select query, query_plan, warning from pgxc_wlm_session_history where query like '%Test statistics not collect%' order by 1;
                                                           query                                                           |                                                  query_plan                                                   |                                     warning                                     
---------------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------
--? /\* Test statistics not collect operator level \*/ select count(\*), t62.c1 from t61 join t62 on t61.c2 = t62.c2 group by 2; |  1 | Streaming (type: GATHER)  (.*)                                         +| Statistic Not Collect:                                                         +
--?                                                                                                                           |  2 |  ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)                      +|     sql_self_tuning_3.t61(c1,c2)                                               +
--?                                                                                                                           |  3 |   ->  HashAggregate  (.*)                                              +|     sql_self_tuning_3.t62(c1,c2)                                               +
                                                                                                                           |    |    Group By Key: t62.c1                                                                                 +| 
--?                                                                                                                           |  4 |    ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*)               +| 
--?                                                                                                                           |  5 |     ->  Hash Join  (.*)                                                 +| 
                                                                                                                           |    |      Hash Cond: (t61.c2 = t62.c2)                                                                       +| 
--?                                                                                                                           |  6 |      ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*)              +| 
--?                                                                                                                           |  7 |       ->  Seq Scan on t61  (.*)                                          +| 
--?                                                                                                                           |  8 |      ->  Hash  (.*)                                                     +| 
--?                                                                                                                           |  9 |       ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*)             +| 
--?                                                                                                                           | 10 |        ->  Seq Scan on t62  (.*)                                          | 
--? /\* Test statistics not collect operator level \*/ select count(\*), t63.c1 from t61 join t63 on t61.c2 = t63.c2 group by 2; |  1 | Streaming (type: GATHER)  (.*)                           +| Statistic Not Collect:                                                         +
--?                                                                                                                           |  2 |  ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)        +|     sql_self_tuning_3.t61(c1,c2)                                               +
--?                                                                                                                           |  3 |   ->  HashAggregate  (.*)                                +|                                                                                +
                                                                                                                           |    |    Group By Key: t63.c1                                                                                 +|                                                                                +
--?                                                                                                                           |  4 |    ->  Streaming(type: LOCAL REDISTRIBUTE dop: 2/2)  (.*)+| PlanNode[7] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:0, E-Rows:90000000000
--?                                                                                                                           |  5 |     ->  HashAggregate  (.*)                              +| 
                                                                                                                           |    |      Group By Key: t63.c1                                                                               +| 
--?                                                                                                                           |  6 |      ->  Hash Join  (.*)                                 +| 
                                                                                                                           |    |       Hash Cond: (t63.c2 = t61.c2)                                                                      +| 
--?                                                                                                                           |  7 |       ->  Seq Scan on t63  (.*)                            +| 
--?                                                                                                                           |  8 |       ->  Hash  (.*)                                                   +| 
--?                                                                                                                           |  9 |        ->  Streaming(type: SPLIT BROADCAST dop: 2/2)  (.*)              +| 
--?                                                                                                                           | 10 |         ->  Seq Scan on t61  (.*)                                         | 
--? /\* Test statistics not collect query level \*/ select count(\*), t62.c1 from t61 join t62 on t61.c2 = t62.c2 group by 2;    |  1 | Streaming (type: GATHER)  (.*)                                         +| Statistic Not Collect:                                                         +
--?                                                                                                                           |  2 |  ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)                      +|     sql_self_tuning_3.t61(c1,c2)                                               +
--?                                                                                                                           |  3 |   ->  HashAggregate  (.*)                                              +|     sql_self_tuning_3.t62(c1,c2)                                               +
                                                                                                                           |    |    Group By Key: t62.c1                                                                                 +| 
--?                                                                                                                           |  4 |    ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*)               +| 
--?                                                                                                                           |  5 |     ->  Hash Join  (.*)                                                 +| 
                                                                                                                           |    |      Hash Cond: (t61.c2 = t62.c2)                                                                       +| 
--?                                                                                                                           |  6 |      ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*)              +| 
--?                                                                                                                           |  7 |       ->  Seq Scan on t61  (.*)                                          +| 
--?                                                                                                                           |  8 |      ->  Hash  (.*)                                                     +| 
--?                                                                                                                           |  9 |       ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*)             +| 
--?                                                                                                                           | 10 |        ->  Seq Scan on t62  (.*)                                          | 
--? /\* Test statistics not collect query level \*/ select count(\*), t63.c1 from t61 join t63 on t61.c2 = t63.c2 group by 2;    |  1 | Streaming (type: GATHER)  (.*)                           +| Statistic Not Collect:                                                         +
--?                                                                                                                           |  2 |  ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)        +|     sql_self_tuning_3.t61(c1,c2)                                               +
--?                                                                                                                           |  3 |   ->  HashAggregate  (.*)                                +| 
                                                                                                                           |    |    Group By Key: t63.c1                                                                                 +| 
--?                                                                                                                           |  4 |    ->  Streaming(type: LOCAL REDISTRIBUTE dop: 2/2)  (.*)+| 
--?                                                                                                                           |  5 |     ->  HashAggregate  (.*)                              +| 
                                                                                                                           |    |      Group By Key: t63.c1                                                                               +| 
--?                                                                                                                           |  6 |      ->  Hash Join  (.*)                                 +| 
                                                                                                                           |    |       Hash Cond: (t63.c2 = t61.c2)                                                                      +| 
--?                                                                                                                           |  7 |       ->  Seq Scan on t63  (.*)                            +| 
--?                                                                                                                           |  8 |       ->  Hash  (.*)                                                   +| 
--?                                                                                                                           |  9 |        ->  Streaming(type: SPLIT BROADCAST dop: 2/2)  (.*)              +| 
--?                                                                                                                           | 10 |         ->  Seq Scan on t61  (.*)                                         | 
(4 rows)

/*
 * SQL-Self Tuning scenario[7] Test case for Estimated row not accurate
 */
create table t8(c1 int, c2 int, c3 int);
insert into t8 select v,v,v from generate_series(1,100) as v;
update pg_class set reltuples = 90000000000 where relname = 't8';
-- Do test
/* Test inaccurate estimation rows */ select count(*), c2 from t8 group by 2 order by 2;
 count | c2  
-------+-----
     1 |   1
     1 |   2
     1 |   3
     1 |   4
     1 |   5
     1 |   6
     1 |   7
     1 |   8
     1 |   9
     1 |  10
     1 |  11
     1 |  12
     1 |  13
     1 |  14
     1 |  15
     1 |  16
     1 |  17
     1 |  18
     1 |  19
     1 |  20
     1 |  21
     1 |  22
     1 |  23
     1 |  24
     1 |  25
     1 |  26
     1 |  27
     1 |  28
     1 |  29
     1 |  30
     1 |  31
     1 |  32
     1 |  33
     1 |  34
     1 |  35
     1 |  36
     1 |  37
     1 |  38
     1 |  39
     1 |  40
     1 |  41
     1 |  42
     1 |  43
     1 |  44
     1 |  45
     1 |  46
     1 |  47
     1 |  48
     1 |  49
     1 |  50
     1 |  51
     1 |  52
     1 |  53
     1 |  54
     1 |  55
     1 |  56
     1 |  57
     1 |  58
     1 |  59
     1 |  60
     1 |  61
     1 |  62
     1 |  63
     1 |  64
     1 |  65
     1 |  66
     1 |  67
     1 |  68
     1 |  69
     1 |  70
     1 |  71
     1 |  72
     1 |  73
     1 |  74
     1 |  75
     1 |  76
     1 |  77
     1 |  78
     1 |  79
     1 |  80
     1 |  81
     1 |  82
     1 |  83
     1 |  84
     1 |  85
     1 |  86
     1 |  87
     1 |  88
     1 |  89
     1 |  90
     1 |  91
     1 |  92
     1 |  93
     1 |  94
     1 |  95
     1 |  96
     1 |  97
     1 |  98
     1 |  99
     1 | 100
(100 rows)

-- Verify diagnosis results
select query, query_plan, warning from pgxc_wlm_session_history where query like '%Test inaccurate estimation rows%' order by 3;
                                          query                                           |                                                   query_plan                                                   |                                      warning                                      
------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------
--? /\* Test inaccurate estimation rows \*/ select count(\*), c2 from t8 group by 2 order by 2; | 1 | Streaming (type: GATHER)  (.*)                             +| Statistic Not Collect:                                                           +
                                                                                          |   |  Merge Sort Key: c2                                                                                       +|     sql_self_tuning_3.t8(c1,c2)                                                  +
--?                                                                                          | 2 |  ->  Sort  (.*)                                            +|                                                                                  +
                                                                                          |   |   Sort Key: c2                                                                                            +|                                                                                  +
--?                                                                                          | 3 |   ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)         +| PlanNode[7] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:100, E-Rows:90000000000
--?                                                                                          | 4 |    ->  HashAggregate  (.*)                                 +| 
                                                                                          |   |     Group By Key: c2                                                                                      +| 
--?                                                                                          | 5 |     ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*)+| 
--?                                                                                          | 6 |      ->  HashAggregate  (.*)                              +| 
                                                                                          |   |       Group By Key: c2                                                                                    +| 
--?                                                                                          | 7 |       ->  Seq Scan on t8  (.*)                                | 
(1 row)

drop table t8;
/* Additional test */
/* SQL with LIMIT clause only reports issue in query level scope */
set resource_track_level=query;
/* Query with LIMIT in query level */ select count(*), t63.c1 from t61 join t63 on t61.c2 = t63.c2 group by 2 LIMIT 1;
 count | c1 
-------+----
(0 rows)

select query, query_plan, warning from pgxc_wlm_session_history where query like '%Query with LIMIT in query level%' order by 1;
                                                         query                                                          |                                                   query_plan                                                    |             warning              
------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------+----------------------------------
--? /\* Query with LIMIT in query level \*/ select count(\*), t63.c1 from t61 join t63 on t61.c2 = t63.c2 group by 2 LIMIT 1; |  1 | Limit  (.*)                                                  +| Statistic Not Collect:          +
--?                                                                                                                        |  2 |  ->  Streaming (type: GATHER)  (.*)                         +|     sql_self_tuning_3.t61(c1,c2)+
--?                                                                                                                        |  3 |   ->  Limit  (.*)                                           +| 
--?                                                                                                                        |  4 |    ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)        +| 
--?                                                                                                                        |  5 |     ->  HashAggregate  (.*)                                +| 
                                                                                                                        |    |      Group By Key: t63.c1                                                                                 +| 
--?                                                                                                                        |  6 |      ->  Streaming(type: LOCAL REDISTRIBUTE dop: 2/2)  (.*)+| 
--?                                                                                                                        |  7 |       ->  HashAggregate  (.*)                              +| 
                                                                                                                        |    |        Group By Key: t63.c1                                                                               +| 
--?                                                                                                                        |  8 |        ->  Hash Join  (.*)                                 +| 
                                                                                                                        |    |         Hash Cond: (t63.c2 = t61.c2)                                                                      +| 
--?                                                                                                                        |  9 |         ->  Seq Scan on t63  (.*)                            +| 
--?                                                                                                                        | 10 |         ->  Hash  (.*)                                                   +| 
--?                                                                                                                        | 11 |          ->  Streaming(type: SPLIT BROADCAST dop: 2/2)  (.*)              +| 
--?                                                                                                                        | 12 |           ->  Seq Scan on t61  (.*)                                         | 
(1 row)

set resource_track_level=operator;
/* Query with LIMIT in operator level */ select count(*), t63.c1 from t61 join t63 on t61.c2 = t63.c2 group by 2 LIMIT 1;
 count | c1 
-------+----
(0 rows)

select query, query_plan, warning from pgxc_wlm_session_history where query like '%Query with LIMIT in operator level%' order by 1;
                                                           query                                                           |                                                   query_plan                                                    |             warning              
---------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------+----------------------------------
--? /\* Query with LIMIT in operator level \*/ select count(\*), t63.c1 from t61 join t63 on t61.c2 = t63.c2 group by 2 LIMIT 1; |  1 | Limit  (.*)                                                  +| Statistic Not Collect:          +
--?                                                                                                                           |  2 |  ->  Streaming (type: GATHER)  (.*)                         +|     sql_self_tuning_3.t61(c1,c2)+
--?                                                                                                                           |  3 |   ->  Limit  (.*)                                           +| 
--?                                                                                                                           |  4 |    ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)        +| 
--?                                                                                                                           |  5 |     ->  HashAggregate  (.*)                                +| 
                                                                                                                           |    |      Group By Key: t63.c1                                                                                 +| 
--?                                                                                                                           |  6 |      ->  Streaming(type: LOCAL REDISTRIBUTE dop: 2/2)  (.*)+| 
--?                                                                                                                           |  7 |       ->  HashAggregate  (.*)                              +| 
                                                                                                                           |    |        Group By Key: t63.c1                                                                               +| 
--?                                                                                                                           |  8 |        ->  Hash Join  (.*)                                 +| 
                                                                                                                           |    |         Hash Cond: (t63.c2 = t61.c2)                                                                      +| 
--?                                                                                                                           |  9 |         ->  Seq Scan on t63  (.*)                            +| 
--?                                                                                                                           | 10 |         ->  Hash  (.*)                                                   +| 
--?                                                                                                                           | 11 |          ->  Streaming(type: SPLIT BROADCAST dop: 2/2)  (.*)              +| 
--?                                                                                                                           | 12 |           ->  Seq Scan on t61  (.*)                                         | 
(1 row)

/* Query without LIMIT in operator level */ select count(*), t63.c1 from t61 join t63 on t61.c2 = t63.c2 group by 2;
 count | c1 
-------+----
(0 rows)

select query, query_plan, warning from pgxc_wlm_session_history where query like '%Query without LIMIT in operator level%' order by 1;
                                                        query                                                         |                                                  query_plan                                                   |                                     warning                                     
----------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------
--? /\* Query without LIMIT in operator level \*/ select count(\*), t63.c1 from t61 join t63 on t61.c2 = t63.c2 group by 2; |  1 | Streaming (type: GATHER)  (.*)                           +| Statistic Not Collect:                                                         +
--?                                                                                                                      |  2 |  ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)        +|     sql_self_tuning_3.t61(c1,c2)                                               +
--?                                                                                                                      |  3 |   ->  HashAggregate  (.*)                                +|                                                                                +
                                                                                                                      |    |    Group By Key: t63.c1                                                                                 +|                                                                                +
--?                                                                                                                      |  4 |    ->  Streaming(type: LOCAL REDISTRIBUTE dop: 2/2)  (.*)+| PlanNode[7] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:0, E-Rows:90000000000
--?                                                                                                                      |  5 |     ->  HashAggregate  (.*)                              +| 
                                                                                                                      |    |      Group By Key: t63.c1                                                                               +| 
--?                                                                                                                      |  6 |      ->  Hash Join  (.*)                                 +| 
                                                                                                                      |    |       Hash Cond: (t63.c2 = t61.c2)                                                                      +| 
--?                                                                                                                      |  7 |       ->  Seq Scan on t63  (.*)                            +| 
--?                                                                                                                      |  8 |       ->  Hash  (.*)                                                   +| 
--?                                                                                                                      |  9 |        ->  Streaming(type: SPLIT BROADCAST dop: 2/2)  (.*)              +| 
--?                                                                                                                      | 10 |         ->  Seq Scan on t61  (.*)                                         | 
(1 row)

drop table t61;
drop table t62;
drop table t63;
-- test create table as
create table t12(c1 int, c2 int, c3 int) distribute by hash(c1);
create table t13(c1 int, c2 int, c3 int) distribute by hash(c1);
insert into t12 select v,v,v from generate_series(1,20) as v;
insert into t13 select * from t12;
update pg_class set reltuples = 1200000 where relname in ('t12', 't13');
create table t11 as
/* CREATE table AS test */select a.* from t12 as a, t13 as b where a.c2 = b.c2;
select query, query_plan, warning from pgxc_wlm_session_history where query like '%CREATE table AS test%' order by 1;
                                      query                                      |                                              query_plan                                               |                                   warning                                    
---------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------
--? create table t11 as                                                            +| 1 | Streaming (type: GATHER)  (.*)                            +| Statistic Not Collect:                                                      +
--? /\* CREATE table AS test \*/select a.* from t12 as a, t13 as b where a.c2 = b.c2; | 2 |  ->  Insert on t11  (.*)                         +|     sql_self_tuning_3.t12(c1,c2)                                            +
--?                                                                                 | 3 |   ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)+|                                                                             +
--?                                                                                 | 4 |    ->  Hash Join  (.*)                            +|                                                                             +
                                                                                 |   |     Hash Cond: (b.c2 = a.c2)                                                                     +| PlanNode[6] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:1200000+
--?                                                                                 | 5 |     ->  Streaming(type: SPLIT BROADCAST dop: 2/2)  (.*)  +| PlanNode[8] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:1200000
--?                                                                                 | 6 |      ->  Seq Scan on t13 b  (.*)                            +| 
--?                                                                                 | 7 |     ->  Hash  (.*)                                      +| 
--?                                                                                 | 8 |      ->  Seq Scan on t12 a  (.*)                            | 
(1 row)

drop table t11;
drop table t12;
drop table t13;
/* test delete-using can be found operator level issue */
create table t12(c1 int, c2 int, c3 int) distribute by hash(c1);
create table t13(c1 int, c2 int, c3 int) distribute by hash(c1);
insert into t12 select v,v,v from generate_series(1,20) as v;
insert into t13 select * from t12;
update pg_class set reltuples = 1200000 where relname in ('t12', 't13');
/* delete using's select */select * from t12 as a, t13 as b where a.c2 = b.c2 order by 1;
 c1 | c2 | c3 | c1 | c2 | c3 
----+----+----+----+----+----
  1 |  1 |  1 |  1 |  1 |  1
  2 |  2 |  2 |  2 |  2 |  2
  3 |  3 |  3 |  3 |  3 |  3
  4 |  4 |  4 |  4 |  4 |  4
  5 |  5 |  5 |  5 |  5 |  5
  6 |  6 |  6 |  6 |  6 |  6
  7 |  7 |  7 |  7 |  7 |  7
  8 |  8 |  8 |  8 |  8 |  8
  9 |  9 |  9 |  9 |  9 |  9
 10 | 10 | 10 | 10 | 10 | 10
 11 | 11 | 11 | 11 | 11 | 11
 12 | 12 | 12 | 12 | 12 | 12
 13 | 13 | 13 | 13 | 13 | 13
 14 | 14 | 14 | 14 | 14 | 14
 15 | 15 | 15 | 15 | 15 | 15
 16 | 16 | 16 | 16 | 16 | 16
 17 | 17 | 17 | 17 | 17 | 17
 18 | 18 | 18 | 18 | 18 | 18
 19 | 19 | 19 | 19 | 19 | 19
 20 | 20 | 20 | 20 | 20 | 20
(20 rows)

/* delete using */delete from t12 as a using t13 as b where a.c2 = b.c2;
select query, query_plan, warning from pgxc_wlm_session_history where query like '%delete using%' order by 1;
                                           query                                           |                                               query_plan                                               |                                   warning                                    
-------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------
--? /\* delete using \*/delete from t12 as a using t13 as b where a.c2 = b.c2;                  | 1 | Streaming (type: GATHER)  (.*)                           +| Statistic Not Collect:                                                      +
--?                                                                                           | 2 |  ->  Delete on t12 a  (.*)                      +|     sql_self_tuning_3.t12(c1,c2)                                            +
--?                                                                                           | 3 |   ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*) +|                                                                             +
--?                                                                                           | 4 |    ->  Hash Join  (.*)                             +|                                                                             +
                                                                                           |   |     Hash Cond: (b.c2 = a.c2)                                                                      +| PlanNode[6] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:1200000+
--?                                                                                           | 5 |     ->  Streaming(type: SPLIT BROADCAST dop: 2/2)  (.*)  +| PlanNode[8] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:1200000
--?                                                                                           | 6 |      ->  Seq Scan on t13 b  (.*)                            +| 
--?                                                                                           | 7 |     ->  Hash  (.*)                                       +| 
--?                                                                                           | 8 |      ->  Seq Scan on t12 a  (.*)                             | 
--? /\* delete using's select \*/select \* from t12 as a, t13 as b where a.c2 = b.c2 order by 1; | 1 | Streaming (type: GATHER)  (.*)              +| Statistic Not Collect:                                                      +
                                                                                           |   |  Merge Sort Key: a.c1                                                                             +|     sql_self_tuning_3.t12(c1,c2)                                            +
--?                                                                                           | 2 |  ->  Sort  (.*)                             +|                                                                             +
                                                                                           |   |   Sort Key: a.c1                                                                                  +|                                                                             +
--?                                                                                           | 3 |   ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)+| PlanNode[6] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:1200000+
--?                                                                                           | 4 |    ->  Hash Join  (.*)                            +| PlanNode[9] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:1200000
                                                                                           |   |     Hash Cond: (a.c2 = b.c2)                                                                      +| 
--?                                                                                           | 5 |     ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*) +| 
--?                                                                                           | 6 |      ->  Seq Scan on t12 a  (.*)                            +| 
--?                                                                                           | 7 |     ->  Hash  (.*)                                     +| 
--?                                                                                           | 8 |      ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*)+| 
--?                                                                                           | 9 |       ->  Seq Scan on t13 b  (.*)                            | 
(2 rows)

drop table t12;
drop table t13;
/* test update-using can be found operator level issue */
create table t12(c1 int, c2 int, c3 int) distribute by hash(c1);
create table t13(c1 int, c2 int, c3 int) distribute by hash(c1);
insert into t12 select v,v,v from generate_series(1,20) as v;
insert into t13 select * from t12;
update pg_class set reltuples = 1200000 where relname in ('t12', 't13');
/* update using's select */select * from t12 as a, t13 as b where a.c2 = b.c2 order by 1;
 c1 | c2 | c3 | c1 | c2 | c3 
----+----+----+----+----+----
  1 |  1 |  1 |  1 |  1 |  1
  2 |  2 |  2 |  2 |  2 |  2
  3 |  3 |  3 |  3 |  3 |  3
  4 |  4 |  4 |  4 |  4 |  4
  5 |  5 |  5 |  5 |  5 |  5
  6 |  6 |  6 |  6 |  6 |  6
  7 |  7 |  7 |  7 |  7 |  7
  8 |  8 |  8 |  8 |  8 |  8
  9 |  9 |  9 |  9 |  9 |  9
 10 | 10 | 10 | 10 | 10 | 10
 11 | 11 | 11 | 11 | 11 | 11
 12 | 12 | 12 | 12 | 12 | 12
 13 | 13 | 13 | 13 | 13 | 13
 14 | 14 | 14 | 14 | 14 | 14
 15 | 15 | 15 | 15 | 15 | 15
 16 | 16 | 16 | 16 | 16 | 16
 17 | 17 | 17 | 17 | 17 | 17
 18 | 18 | 18 | 18 | 18 | 18
 19 | 19 | 19 | 19 | 19 | 19
 20 | 20 | 20 | 20 | 20 | 20
(20 rows)

/* update using */update t12 as a set c3 =0 from t13 as b where a.c2 = b.c2;
select query, query_plan, warning from pgxc_wlm_session_history where query like '%update using%' order by 1;
                                           query                                           |                                               query_plan                                               |                                   warning                                    
-------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------
--? /\* update using's select \*/select \* from t12 as a, t13 as b where a.c2 = b.c2 order by 1; | 1 | Streaming (type: GATHER)  (.*)              +| Statistic Not Collect:                                                      +
                                                                                           |   |  Merge Sort Key: a.c1                                                                             +|     sql_self_tuning_3.t12(c1,c2)                                            +
--?                                                                                           | 2 |  ->  Sort  (.*)                             +|                                                                             +
                                                                                           |   |   Sort Key: a.c1                                                                                  +|                                                                             +
--?                                                                                           | 3 |   ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)+| PlanNode[6] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:1200000+
--?                                                                                           | 4 |    ->  Hash Join  (.*)                            +| PlanNode[9] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:1200000
                                                                                           |   |     Hash Cond: (a.c2 = b.c2)                                                                      +| 
--?                                                                                           | 5 |     ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*) +| 
--?                                                                                           | 6 |      ->  Seq Scan on t12 a  (.*)                            +| 
--?                                                                                           | 7 |     ->  Hash  (.*)                                     +| 
--?                                                                                           | 8 |      ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*)+| 
--?                                                                                           | 9 |       ->  Seq Scan on t13 b  (.*)                            | 
--? /\* update using \*/update t12 as a set c3 =0 from t13 as b where a.c2 = b.c2;              | 1 | Streaming (type: GATHER)  (.*)                           +| Statistic Not Collect:                                                      +
--?                                                                                           | 2 |  ->  Update on t12 a  (.*)                      +|     sql_self_tuning_3.t12(c1,c2)                                            +
--?                                                                                           | 3 |   ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*) +|                                                                             +
--?                                                                                           | 4 |    ->  Hash Join  (.*)                             +|                                                                             +
                                                                                           |   |     Hash Cond: (b.c2 = a.c2)                                                                      +| PlanNode[6] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:1200000+
--?                                                                                           | 5 |     ->  Streaming(type: SPLIT BROADCAST dop: 2/2)  (.*)  +| PlanNode[8] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:1200000
--?                                                                                           | 6 |      ->  Seq Scan on t13 b  (.*)                            +| 
--?                                                                                           | 7 |     ->  Hash  (.*)                                       +| 
--?                                                                                           | 8 |      ->  Seq Scan on t12 a  (.*)                             | 
(2 rows)

drop table t12;
drop table t13;
/* test insert can be found operator level issue */
create table t12(c1 int, c2 int, c3 int) distribute by hash(c1);
create table t13(c1 int, c2 int, c3 int) distribute by hash(c1);
update pg_class set reltuples = 12000000 where relname in ('t12', 't13');
insert into t12 select v,v,v from generate_series(1,20) as v;
/* insert test's select */select * from t12 where c2 < 15 order by 1;
 c1 | c2 | c3 
----+----+----
  1 |  1 |  1
  2 |  2 |  2
  3 |  3 |  3
  4 |  4 |  4
  5 |  5 |  5
  6 |  6 |  6
  7 |  7 |  7
  8 |  8 |  8
  9 |  9 |  9
 10 | 10 | 10
 11 | 11 | 11
 12 | 12 | 12
 13 | 13 | 13
 14 | 14 | 14
(14 rows)

/* insert test */insert into t13 select * from t12 where c2 < 15 order by 1;
select query, query_plan, warning from pgxc_wlm_session_history where query like '%insert test%' order by 1;
                                    query                                     |                                           query_plan                                           |                                   warning                                    
------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------
--? /\* insert test \*/insert into t13 select \* from t12 where c2 < 15 order by 1; | 1 | Streaming (type: GATHER)  (.*)                      +| Statistic Not Collect:                                                      +
--?                                                                              | 2 |  ->  Insert on t13  (.*)                      +|     sql_self_tuning_3.t12(c1,c2)                                            +
--?                                                                              | 3 |   ->  Sort  (.*)                               +|                                                                             +
                                                                              |   |    Sort Key: t12.c1                                                                       +|                                                                             +
--?                                                                              | 4 |    ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)+| PlanNode[5] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:14, E-Rows:4000000
--?                                                                              | 5 |     ->  Seq Scan on t12  (.*)                      +| 
                                                                              |   |      Filter: (c2 < 15)                                                                     | 
--? /\* insert test's select \*/select \* from t12 where c2 < 15 order by 1;        | 1 | Streaming (type: GATHER)  (.*)                +| Statistic Not Collect:                                                      +
                                                                              |   |  Merge Sort Key: c1                                                                       +|     sql_self_tuning_3.t12(c1,c2)                                            +
--?                                                                              | 2 |  ->  Sort  (.*)                                +|                                                                             +
                                                                              |   |   Sort Key: c1                                                                            +|                                                                             +
--?                                                                              | 3 |   ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*) +| PlanNode[4] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:14, E-Rows:4000000
--?                                                                              | 4 |    ->  Seq Scan on t12  (.*)                       +| 
                                                                              |   |     Filter: (c2 < 15)                                                                      | 
(2 rows)

drop table t12;
drop table t13;
-- test initplan && subplan
create table t01(c1 int, c2 int, c3 int);
create table t02(c1 int, c2 int, c3 int);
insert into t01 select v,v,v from generate_series(1,20) as v;
insert into t02 select * from t01;
analyze t01;
analyze t02;
update pg_class set reltuples = 10000000 where relname in ('t01', 't02');
/* test initplan (none-correlated subquery ) */select *
from t01 where c2 < (select c3 from t02 where t02.c2 = 1);
 c1 | c2 | c3 
----+----+----
(0 rows)

/* test subplan (none-correlated subquery ) */select *
from t01 where c2 < (select c3 from t02 where t02.c3 = t01.c3);
 c1 | c2 | c3 
----+----+----
(0 rows)

select query, query_plan, warning from pgxc_wlm_session_history where query like '%test initplan%' or query like '%test subplan%' order by 1;
                              query                              |                                       query_plan                                        |                                    warning                                    
-----------------------------------------------------------------+-----------------------------------------------------------------------------------------+-------------------------------------------------------------------------------
--? /\* test initplan (none-correlated subquery ) \*/select \*        +| 1 | Streaming (type: GATHER)  (.*)         +| PlanNode[2] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:0, E-Rows:3333333
 from t01 where c2 < (select c3 from t02 where t02.c2 = 1);      |   |  InitPlan 1 (returns $0)                                                           +| 
--?                                                                 | 3 |   ->  Streaming(type: BROADCAST)  (.*)            +| 
--?                                                                 | 4 |    ->  Seq Scan on t02  (.*)                       +| 
                                                                 |   |     Filter: (c2 = 1)                                                               +| 
--?                                                                 | 2 |  ->  Seq Scan on t01  (.*)                   +| 
                                                                 |   |   Filter: (c2 < $0)                                                                 | 
--? /\* test subplan (none-correlated subquery ) \*/select \*         +| 1 | Streaming (type: GATHER)  (.*)       +| PlanNode[6] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:10000000+
--? from t01 where c2 < (select c3 from t02 where t02.c3 = t01.c3); | 2 |  ->  Seq Scan on t01  (.*)           +| PlanNode[3] Inaccurate Estimation-Rows: "Result" A-Rows:20, E-Rows:120000000 +
                                                                 |   |   Filter: (c2 < (SubPlan 1))                                                       +| PlanNode[2] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:0, E-Rows:3333333
                                                                 |   |   SubPlan 1                                                                        +| 
--?                                                                 | 3 |    ->  Result  (.*)                      +| 
                                                                 |   |     Filter: (t02.c3 = t01.c3)                                                      +| 
--?                                                                 | 4 |     ->  Materialize  (.*)                +| 
--?                                                                 | 5 |      ->  Streaming(type: BROADCAST)  (.*)+| 
--?                                                                 | 6 |       ->  Seq Scan on t02  (.*)               | 
(2 rows)

drop table t01;
drop table t02;
-- test rescan case when we found materialize plan node 
create table t01(c1 int, c2 int, c3 int);
create table t02(c1 int, c2 int, c3 int);
insert into t01 select v,v,v from generate_series(1,20) as v;
insert into t02 select * from t01;
update pg_class set reltuples = 9000000 where relname in ('t01', 't02');
/* Skip rescan erows reporting */
select /*+ nestloop(t01 t02) */ * from t01 join t02 on t01.c2 = t02.c2 order by 1;
 c1 | c2 | c3 | c1 | c2 | c3 
----+----+----+----+----+----
  1 |  1 |  1 |  1 |  1 |  1
  2 |  2 |  2 |  2 |  2 |  2
  3 |  3 |  3 |  3 |  3 |  3
  4 |  4 |  4 |  4 |  4 |  4
  5 |  5 |  5 |  5 |  5 |  5
  6 |  6 |  6 |  6 |  6 |  6
  7 |  7 |  7 |  7 |  7 |  7
  8 |  8 |  8 |  8 |  8 |  8
  9 |  9 |  9 |  9 |  9 |  9
 10 | 10 | 10 | 10 | 10 | 10
 11 | 11 | 11 | 11 | 11 | 11
 12 | 12 | 12 | 12 | 12 | 12
 13 | 13 | 13 | 13 | 13 | 13
 14 | 14 | 14 | 14 | 14 | 14
 15 | 15 | 15 | 15 | 15 | 15
 16 | 16 | 16 | 16 | 16 | 16
 17 | 17 | 17 | 17 | 17 | 17
 18 | 18 | 18 | 18 | 18 | 18
 19 | 19 | 19 | 19 | 19 | 19
 20 | 20 | 20 | 20 | 20 | 20
(20 rows)

select query, query_plan, warning from pgxc_wlm_session_history where query like '%Skip rescan erows reporting%' order by 1;
                                       query                                        |                                                query_plan                                                |                                   warning                                    
------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------
--? /\* Skip rescan erows reporting \*/                                                 +| 1 | Streaming (type: GATHER)  (.*)          +| Statistic Not Collect:                                                      +
 select /*+ nestloop(t01 t02) */ * from t01 join t02 on t01.c2 = t02.c2 order by 1; |   |  Merge Sort Key: t01.c1                                                                             +|     sql_self_tuning_3.t01(c1,c2)                                            +
--?                                                                                    | 2 |  ->  Sort  (.*)                         +|                                                                             +
                                                                                    |   |   Sort Key: t01.c1                                                                                  +|                                                                             +
--?                                                                                    | 3 |   ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)+| PlanNode[6] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:9000000+
--?                                                                                    | 4 |    ->  Nested Loop  (.*)                          +| PlanNode[9] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:9000000
                                                                                    |   |     Join Filter: (t01.c2 = t02.c2)                                                                  +| 
--?                                                                                    | 5 |     ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*)  +| 
--?                                                                                    | 6 |      ->  Seq Scan on t01  (.*)                                +| 
--?                                                                                    | 7 |     ->  Materialize  (.*)                                   +| 
--?                                                                                    | 8 |      ->  Streaming(type: SPLIT REDISTRIBUTE dop: 2/2)  (.*) +| 
--?                                                                                    | 9 |       ->  Seq Scan on t02  (.*)                                | 
(1 row)

drop table t01;
drop table t02;
/* test deduplicate with append plan */
create table t01(c1 int, c2 int, c3 int);
create table t02(c1 int, c2 int, c3 int);
insert into t01 select v,v,v from generate_series(1,20) as v;
insert into t02 select * from t01;
analyze t01;
analyze t02;
update pg_class set reltuples = 10000000 where relname in ('t01', 't02');
/*test setop*/select count(*)
from (select c1,c2 from t01 union all select c1,c2 from t02) as dt;
 count 
-------
    40
(1 row)

/*test setop*/select count(*)
from (select c1,c2 from t01 union select c1,c2 from t02) as dt;
 count 
-------
    20
(1 row)

select query, query_plan, warning from pgxc_wlm_session_history where query like '%test setop%' order by 1,2,3;
                                query                                |                                               query_plan                                                |                                    warning                                     
---------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------
--? /\*test setop\*/select count(\*)                                      +| 1 | Aggregate  (.*)                                                +| PlanNode[6] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:10000000 +
--? from (select c1,c2 from t01 union all select c1,c2 from t02) as dt; | 2 |  ->  Streaming (type: GATHER)  (.*)                           +| PlanNode[7] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:10000000
--?                                                                     | 3 |   ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)            +| 
--?                                                                     | 4 |    ->  Aggregate  (.*)                                        +| 
--?                                                                     | 5 |     ->  Append  (.*)                                         +| 
--?                                                                     | 6 |      ->  Seq Scan on t01  (.*)                               +| 
--?                                                                     | 7 |      ->  Seq Scan on t02  (.*)                                | 
--? /\*test setop\*/select count(\*)                                      +|  1 | Aggregate  (.*)                                               +| PlanNode[8] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:10000000 +
--? from (select c1,c2 from t01 union select c1,c2 from t02) as dt;     |  2 |  ->  Streaming (type: GATHER)  (.*)                          +| PlanNode[10] Inaccurate Estimation-Rows: "Seq Scan" A-Rows:20, E-Rows:10000000
--?                                                                     |  3 |   ->  Streaming(type: LOCAL GATHER dop: 1/2)  (.*)           +| 
--?                                                                     |  4 |    ->  Aggregate  (.*)                                       +| 
--?                                                                     |  5 |     ->  HashAggregate  (.*)                            +| 
                                                                     |    |      Group By Key: t01.c1, t01.c2                                                                 +| 
--?                                                                     |  6 |      ->  Append  (.*)                                      +| 
--?                                                                     |  7 |       ->  Streaming(type: LOCAL REDISTRIBUTE dop: 2/2)  (.*)+| 
--?                                                                     |  8 |        ->  Seq Scan on t01  (.*)                            +| 
--?                                                                     |  9 |       ->  Streaming(type: LOCAL REDISTRIBUTE dop: 2/2)  (.*)+| 
--?                                                                     | 10 |        ->  Seq Scan on t02  (.*)                             | 
(2 rows)

drop table t01;
drop table t02;
drop schema sql_self_tuning_3 cascade;
reset resource_track_level;
reset resource_track_cost;
reset resource_track_duration;
\c regression
