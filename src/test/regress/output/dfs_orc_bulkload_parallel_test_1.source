set enable_global_stats = true;
--
-- BULK LOAD PARALLEL TEST 1
--
----
-- 1. Load data in normal mode wiht CSV format
----
CREATE TABLE LINEITEM
(
    L_ORDERKEY    BIGINT NOT NULL
  , L_PARTKEY     BIGINT NOT NULL
  , L_SUPPKEY     BIGINT NOT NULL
  , L_LINENUMBER  BIGINT NOT NULL
  , L_QUANTITY    DECIMAL(15,2) NOT NULL
  , L_EXTENDEDPRICE  DECIMAL(15,2) NOT NULL
  , L_DISCOUNT    DECIMAL(15,2) NOT NULL
  , L_TAX         DECIMAL(15,2) NOT NULL
  , L_RETURNFLAG  CHAR(1) NOT NULL
  , L_LINESTATUS  CHAR(1) NOT NULL
  , L_SHIPDATE    DATE NOT NULL
  , L_COMMITDATE  DATE NOT NULL
  , L_RECEIPTDATE DATE NOT NULL
  , L_SHIPINSTRUCT CHAR(25) NOT NULL
  , L_SHIPMODE     CHAR(10) NOT NULL
  , L_COMMENT      VARCHAR(44) NOT NULL
) with (orientation=orc) tablespace hdfs_ts
distribute by hash(L_ORDERKEY);
CREATE FOREIGN TABLE EXT_LINEITEM (
	L_ORDERKEY    BIGINT NOT NULL,        
	L_PARTKEY     BIGINT NOT NULL,        
	L_SUPPKEY     BIGINT NOT NULL,        
	L_LINENUMBER  BIGINT NOT NULL,        
	L_QUANTITY    DECIMAL(15,2) NOT NULL,        
	L_EXTENDEDPRICE  DECIMAL(15,2) NOT NULL,        
	L_DISCOUNT    DECIMAL(15,2) NOT NULL,        
	L_TAX     DECIMAL(15,2) NOT NULL,        
	L_RETURNFLAG  CHAR(1) NOT NULL,        
	L_LINESTATUS  CHAR(1) NOT NULL,        
	L_SHIPDATE    DATE NOT NULL,        
	L_COMMITDATE  DATE NOT NULL,        
	L_RECEIPTDATE DATE NOT NULL,        
	L_SHIPINSTRUCT CHAR(25) NOT NULL,        
	L_SHIPMODE     CHAR(10) NOT NULL,        
	L_COMMENT      VARCHAR(44) NOT NULL
)SERVER gsmpp_server OPTIONS(format 'csv', location 'gsfs://127.0.0.1:8900/lineitem.data', delimiter '|', mode 'normal');
INSERT INTO LINEITEM SELECT * FROM EXT_LINEITEM;
INSERT INTO LINEITEM SELECT * FROM EXT_LINEITEM;
SELECT COUNT(*) FROM LINEITEM;
 count 
-------
 20000
(1 row)

DROP TABLE LINEITEM;
CREATE TABLE LINEITEM
(
    L_ORDERKEY    BIGINT NOT NULL
  , L_PARTKEY     BIGINT NOT NULL
  , L_SUPPKEY     BIGINT NOT NULL
  , L_LINENUMBER  BIGINT NOT NULL
  , L_QUANTITY    DECIMAL(15,2) NOT NULL
  , L_EXTENDEDPRICE  DECIMAL(15,2) NOT NULL
  , L_DISCOUNT    DECIMAL(15,2) NOT NULL
  , L_TAX         DECIMAL(15,2) NOT NULL
  , L_RETURNFLAG  CHAR(1) NOT NULL
  , L_LINESTATUS  CHAR(1) NOT NULL
  , L_SHIPDATE    DATE NOT NULL
  , L_COMMITDATE  DATE NOT NULL
  , L_RECEIPTDATE DATE NOT NULL
  , L_SHIPINSTRUCT CHAR(25) NOT NULL
  , L_SHIPMODE     CHAR(10) NOT NULL
  , L_COMMENT      VARCHAR(44) NOT NULL
) with (orientation=orc) tablespace hdfs_ts
distribute by hash(L_ORDERKEY);
--TRUNCATE LINEITEM;
DROP FOREIGN TABLE EXT_LINEITEM;
----
--2. Load data in normal mode with TEXT format
----
CREATE FOREIGN TABLE EXT_LINEITEM (
        L_ORDERKEY    BIGINT NOT NULL,
        L_PARTKEY     BIGINT NOT NULL,
        L_SUPPKEY     BIGINT NOT NULL,
        L_LINENUMBER  BIGINT NOT NULL,
        L_QUANTITY    DECIMAL(15,2) NOT NULL,
        L_EXTENDEDPRICE  DECIMAL(15,2) NOT NULL,
        L_DISCOUNT    DECIMAL(15,2) NOT NULL,
        L_TAX     DECIMAL(15,2) NOT NULL,
        L_RETURNFLAG  CHAR(1) NOT NULL,
        L_LINESTATUS  CHAR(1) NOT NULL,
        L_SHIPDATE    DATE NOT NULL,
        L_COMMITDATE  DATE NOT NULL,
        L_RECEIPTDATE DATE NOT NULL,
        L_SHIPINSTRUCT CHAR(25) NOT NULL,
        L_SHIPMODE     CHAR(10) NOT NULL,
        L_COMMENT      VARCHAR(44) NOT NULL
)SERVER gsmpp_server OPTIONS(format 'text', location 'gsfs://127.0.0.1:8900/lineitem.data', delimiter '|', mode 'normal');
INSERT INTO LINEITEM SELECT * FROM EXT_LINEITEM;
INSERT INTO LINEITEM SELECT * FROM EXT_LINEITEM;
SELECT COUNT(*) FROM LINEITEM;
 count 
-------
 20000
(1 row)

DROP TABLE LINEITEM;
CREATE TABLE LINEITEM
(
    L_ORDERKEY    BIGINT NOT NULL
  , L_PARTKEY     BIGINT NOT NULL
  , L_SUPPKEY     BIGINT NOT NULL
  , L_LINENUMBER  BIGINT NOT NULL
  , L_QUANTITY    DECIMAL(15,2) NOT NULL
  , L_EXTENDEDPRICE  DECIMAL(15,2) NOT NULL
  , L_DISCOUNT    DECIMAL(15,2) NOT NULL
  , L_TAX         DECIMAL(15,2) NOT NULL
  , L_RETURNFLAG  CHAR(1) NOT NULL
  , L_LINESTATUS  CHAR(1) NOT NULL
  , L_SHIPDATE    DATE NOT NULL
  , L_COMMITDATE  DATE NOT NULL
  , L_RECEIPTDATE DATE NOT NULL
  , L_SHIPINSTRUCT CHAR(25) NOT NULL
  , L_SHIPMODE     CHAR(10) NOT NULL
  , L_COMMENT      VARCHAR(44) NOT NULL
) with (orientation=orc) tablespace hdfs_ts
distribute by hash(L_ORDERKEY);
--TRUNCATE LINEITEM;
DROP FOREIGN TABLE EXT_LINEITEM;
----
---- Load data in normal mode with pipe source
----
\! rm -f @abs_srcdir@/data/datanode1/gds.pipe
\! mkfifo @abs_srcdir@/data/datanode1/gds.pipe
CREATE FOREIGN TABLE PIPE_LINEITEM (
        L_ORDERKEY    BIGINT NOT NULL,
        L_PARTKEY     BIGINT NOT NULL,
        L_SUPPKEY     BIGINT NOT NULL,
        L_LINENUMBER  BIGINT NOT NULL,
        L_QUANTITY    DECIMAL(15,2) NOT NULL,
        L_EXTENDEDPRICE  DECIMAL(15,2) NOT NULL,
        L_DISCOUNT    DECIMAL(15,2) NOT NULL,
        L_TAX     DECIMAL(15,2) NOT NULL,
        L_RETURNFLAG  CHAR(1) NOT NULL,
        L_LINESTATUS  CHAR(1) NOT NULL,
        L_SHIPDATE    DATE NOT NULL,
        L_COMMITDATE  DATE NOT NULL,
        L_RECEIPTDATE DATE NOT NULL,
        L_SHIPINSTRUCT CHAR(25) NOT NULL,
        L_SHIPMODE     CHAR(10) NOT NULL,
        L_COMMENT      VARCHAR(44) NOT NULL
)SERVER gsmpp_server OPTIONS(format 'text', location 'gsfs://127.0.0.1:8900/gds.pipe', delimiter '|', mode 'normal');
\! sh -c "sleep 3;cat @abs_srcdir@/data/datanode1/lineitem.data >@abs_srcdir@/data/datanode1/gds.pipe" &
INSERT INTO LINEITEM SELECT * FROM PIPE_LINEITEM;
SELECT COUNT(*) FROM LINEITEM;
 count 
-------
 10000
(1 row)

DROP TABLE LINEITEM;
CREATE TABLE LINEITEM
(
    L_ORDERKEY    BIGINT NOT NULL
  , L_PARTKEY     BIGINT NOT NULL
  , L_SUPPKEY     BIGINT NOT NULL
  , L_LINENUMBER  BIGINT NOT NULL
  , L_QUANTITY    DECIMAL(15,2) NOT NULL
  , L_EXTENDEDPRICE  DECIMAL(15,2) NOT NULL
  , L_DISCOUNT    DECIMAL(15,2) NOT NULL
  , L_TAX         DECIMAL(15,2) NOT NULL
  , L_RETURNFLAG  CHAR(1) NOT NULL
  , L_LINESTATUS  CHAR(1) NOT NULL
  , L_SHIPDATE    DATE NOT NULL
  , L_COMMITDATE  DATE NOT NULL
  , L_RECEIPTDATE DATE NOT NULL
  , L_SHIPINSTRUCT CHAR(25) NOT NULL
  , L_SHIPMODE     CHAR(10) NOT NULL
  , L_COMMENT      VARCHAR(44) NOT NULL
) with (orientation=orc) tablespace hdfs_ts
distribute by hash(L_ORDERKEY);
--TRUNCATE LINEITEM;
DROP FOREIGN TABLE PIPE_LINEITEM;
\! rm -f @abs_srcdir@/data/datanode1/gds.pipe
----
---- Load data in normal mode for overloaded buffer support
----
CREATE FOREIGN TABLE OVERLOAD_TEST_FT(
col1 text,
col2 text)
SERVER gsmpp_server
OPTIONS(location
'gsfs://127.0.0.1:8900/overload.txt',
format 'csv',
delimiter ',',
encoding 'utf8',
mode 'Normal'
);
CREATE TABLE OVERLOAD_TEST(col1 text,col2 text) tablespace hdfs_ts;
INSERT INTO OVERLOAD_TEST SELECT * FROM OVERLOAD_TEST_FT;
SELECT char_length(col1),char_length(col2) FROM OVERLOAD_TEST order by 1;
 char_length | char_length 
-------------+-------------
      461233 |           1
      531701 |           1
(2 rows)

DROP FOREIGN TABLE OVERLOAD_TEST_FT;
DROP TABLE OVERLOAD_TEST;
----
---- gds foreign table join
----
CREATE FOREIGN TABLE EXT_LINEITEM (
        L_ORDERKEY    BIGINT NOT NULL,
        L_PARTKEY     BIGINT NOT NULL,
        L_SUPPKEY     BIGINT NOT NULL,
        L_LINENUMBER  BIGINT NOT NULL,
        L_QUANTITY    DECIMAL(15,2) NOT NULL,
        L_EXTENDEDPRICE  DECIMAL(15,2) NOT NULL,
        L_DISCOUNT    DECIMAL(15,2) NOT NULL,
        L_TAX     DECIMAL(15,2) NOT NULL,
        L_RETURNFLAG  CHAR(1) NOT NULL,
        L_LINESTATUS  CHAR(1) NOT NULL,
        L_SHIPDATE    DATE NOT NULL,
        L_COMMITDATE  DATE NOT NULL,
        L_RECEIPTDATE DATE NOT NULL,
        L_SHIPINSTRUCT CHAR(25) NOT NULL,
        L_SHIPMODE     CHAR(10) NOT NULL,
        L_COMMENT      VARCHAR(44) NOT NULL
)SERVER gsmpp_server OPTIONS(format 'text', location 'gsfs://127.0.0.1:8900/lineitem.data', delimiter '|', mode 'normal');
SELECT  FT_1.L_ORDERKEY FROM EXT_LINEITEM FT_1 JOIN EXT_LINEITEM FT_2 ON FT_1.L_ORDERKEY = FT_2.L_ORDERKEY GROUP BY FT_1.L_ORDERKEY ORDER BY FT_1.L_ORDERKEY LIMIT 1;
 l_orderkey 
------------
          1
(1 row)

SELECT * FROM EXT_LINEITEM, LINEITEM;
ERROR:  It is not supported that there are both foreign tables and non-foreign tables in one query.
DROP FOREIGN TABLE EXT_LINEITEM;
DROP TABLE LINEITEM;
