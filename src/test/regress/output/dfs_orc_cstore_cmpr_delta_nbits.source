set enable_global_stats = true;
set enable_vector_engine=on;
-- Problem:
-- during delta compression the n-bits and n-bytes holding delta values is computed wrong.
-- if n bits are used, the valid data is [0, 2^n - 1], but excluding 2^n.
-- so that when diff is equal to 2^n, (n+1) bits should be used.
-- Testcase:
-- 1. all values in CU are the same ;
-- 2. there are only two values in CU;
-- 3. delta values is hold by one byte, but not suitable for RLE compression;
-- 4. delta values is hold by one byte, and just suitable for RLE compression;
-- 5. normal case that both delta and rle methods are applied to;
-- 6. the max delta is 2^n, and (n+1) bits are used to store all the delta values;
-- 7. the max delta is during [2^n, 2^(n+1)), and (n+1) bits are used to ;
CREATE TABLE colcmpr_delta_nbits
(
	distKey INT4,
	twoVals INT4,
	downLimitRle INT4,
	minRleValues INT4,
	normalRleVal INT4,
	rleValues    INT4,
	oneByteDelta INT4,
	twoByteDelta INT4,
	f09 INT4,
	f10 INT4,
	f11 INT4
) with (orientation = orc) tablespace hdfs_ts  DISTRIBUTE BY HASH(distkey);
COPY colcmpr_delta_nbits FROM '@abs_srcdir@/data/colcmpr_delta_nbits.data';                                                                                                    
SELECT * FROM colcmpr_delta_nbits;
 distkey | twovals | downlimitrle | minrlevalues | normalrleval | rlevalues | onebytedelta | twobytedelta | f09 | f10 | f11 
---------+---------+--------------+--------------+--------------+-----------+--------------+--------------+-----+-----+-----
     111 |       0 |            1 |            1 |            1 |         1 |            1 |            1 |   1 |   1 |   9
     111 |       1 |            2 |            2 |            2 |         2 |          257 |          258 |  15 |  15 |   0
     111 |       0 |            3 |            3 |            3 |         3 |            1 |            1 |  16 |  16 |   1
     111 |       1 |            1 |            4 |            4 |         4 |          257 |          258 |  17 |  17 |   2
     111 |       0 |            2 |            1 |            5 |         5 |            1 |            1 |   1 |   1 |   3
     111 |       1 |            3 |            2 |            1 |         6 |          257 |          258 |  15 |  15 |   4
     111 |       0 |            1 |            3 |            2 |         1 |            1 |            1 |  16 |  16 |   5
     111 |       1 |            2 |            4 |            3 |         2 |          257 |          258 |  17 |  17 |   6
     111 |       0 |            3 |            1 |            4 |         3 |            1 |            1 |   1 |   1 |   7
     111 |       1 |            1 |            2 |            5 |         4 |          257 |          258 |  15 |  15 |   8
     111 |       0 |            2 |            3 |            1 |         5 |            1 |            1 |  18 |  16 |  20
     111 |       1 |            3 |            4 |            2 |         6 |          257 |          258 |  19 |  17 |  11
     111 |       0 |            1 |            1 |            3 |         1 |            1 |            1 |  20 |   1 |  12
     111 |       1 |            2 |            2 |            4 |         2 |          257 |          258 |  11 |  15 |  13
     111 |       0 |            3 |            3 |            5 |         3 |            1 |            1 |  12 |  16 |  14
     111 |       1 |            1 |            4 |            1 |         4 |          257 |          258 |  13 |  17 |  15
     111 |       0 |            2 |            1 |            2 |         5 |            1 |            1 |  14 |   1 |  16
     111 |       1 |            3 |            2 |            3 |         6 |          257 |          258 |  15 |  15 |  17
     111 |       0 |            1 |            3 |            4 |         1 |            1 |            1 |  16 |  16 |  18
     111 |       1 |            2 |            4 |            5 |         2 |          257 |          258 |  17 |  17 |  19
     111 |       0 |            3 |            1 |            1 |         3 |            1 |            1 |  28 |   1 |  30
     111 |       1 |            1 |            2 |            2 |         4 |          257 |          258 |  29 |  15 |  21
     111 |       0 |            2 |            3 |            3 |         5 |            1 |            1 |  30 |  16 |  22
     111 |       1 |            3 |            4 |            4 |         6 |          257 |          258 |  21 |  17 |  23
     111 |       0 |            1 |            1 |            5 |         1 |            1 |            1 |  22 |   1 |  24
     111 |       1 |            2 |            2 |            1 |         2 |          257 |          258 |  23 |  15 |  25
     111 |       0 |            3 |            3 |            2 |         3 |            1 |            1 |  24 |  16 |  26
     111 |       1 |            1 |            4 |            3 |         4 |          257 |          258 |  25 |  17 |  27
     111 |       0 |            2 |            1 |            4 |         5 |            1 |            1 |  26 |   1 |  28
     111 |       1 |            3 |            2 |            5 |         6 |          257 |          258 |  27 |  15 |  29
     111 |       0 |            1 |            3 |            1 |         1 |            1 |            1 |  38 |  16 |  40
     111 |       1 |            2 |            4 |            2 |         2 |          257 |          258 |  39 |  17 |  31
     111 |       0 |            3 |            1 |            3 |         3 |            1 |            1 |  40 |   1 |  32
     111 |       1 |            1 |            2 |            4 |         4 |          257 |          258 |  31 |  15 |  33
     111 |       0 |            2 |            3 |            5 |         5 |            1 |            1 |  32 |  16 |  34
     111 |       1 |            3 |            4 |            1 |         6 |          257 |          258 |  33 |  17 |  35
     111 |       0 |            1 |            1 |            2 |         1 |            1 |            1 |  34 |   1 |  36
     111 |       1 |            2 |            2 |            3 |         2 |          257 |          258 |  35 |  15 |  37
     111 |       0 |            3 |            3 |            4 |         3 |            1 |            1 |  36 |  16 |  38
     111 |       1 |            1 |            4 |            5 |         4 |          257 |          258 |  37 |  17 |  39
     111 |       0 |            2 |            1 |            1 |         5 |            1 |            1 |  48 |   1 |  50
     111 |       1 |            3 |            2 |            2 |         6 |          257 |          258 |  49 |  15 |  41
     111 |       0 |            1 |            3 |            3 |         1 |            1 |            1 |  50 |  16 |  42
     111 |       1 |            2 |            4 |            4 |         2 |          257 |          258 |  41 |  17 |  43
     111 |       0 |            3 |            1 |            5 |         3 |            1 |            1 |  42 |   1 |  44
     111 |       1 |            1 |            2 |            1 |         4 |          257 |          258 |  43 |  15 |  45
     111 |       0 |            2 |            3 |            2 |         5 |            1 |            1 |  44 |  16 |  46
     111 |       1 |            3 |            4 |            3 |         6 |          257 |          258 |  45 |  17 |  47
     111 |       0 |            1 |            1 |            4 |         1 |            1 |            1 |  46 |   1 |  48
     111 |       1 |            2 |            2 |            5 |         2 |          257 |          258 |  47 |  15 |  49
     111 |       0 |            3 |            3 |            1 |         3 |            1 |            1 |  58 |  16 |  60
     111 |       1 |            1 |            4 |            2 |         4 |          257 |          258 |  59 |  17 |  51
     111 |       0 |            2 |            1 |            3 |         5 |            1 |            1 |  60 |   1 |  52
     111 |       1 |            3 |            2 |            4 |         6 |          257 |          258 |  51 |  15 |  53
     111 |       0 |            1 |            3 |            5 |         1 |            1 |            1 |  52 |  16 |  54
     111 |       1 |            2 |            4 |            1 |         2 |          257 |          258 |  53 |  17 |  55
     111 |       0 |            3 |            1 |            2 |         3 |            1 |            1 |  54 |   1 |  56
     111 |       1 |            1 |            2 |            3 |         4 |          257 |          258 |  55 |  15 |  57
     111 |       0 |            2 |            3 |            4 |         5 |            1 |            1 |  56 |  16 |  58
     111 |       1 |            3 |            4 |            5 |         6 |          257 |          258 |  57 |  17 |  59
     111 |       0 |            1 |            1 |            1 |         1 |            1 |            1 |  68 |   1 |  70
     111 |       1 |            2 |            2 |            2 |         2 |          257 |          258 |  69 |  15 |  61
     111 |       0 |            3 |            3 |            3 |         3 |            1 |            1 |  70 |  16 |  62
     111 |       1 |            1 |            4 |            4 |         4 |          257 |          258 |  61 |  17 |  63
     111 |       0 |            2 |            1 |            5 |         5 |            1 |            1 |  62 |   1 |  64
     111 |       1 |            3 |            2 |            1 |         6 |          257 |          258 |  63 |  15 |  65
     111 |       0 |            1 |            3 |            2 |         1 |            1 |            1 |  64 |  16 |  66
     111 |       1 |            2 |            4 |            3 |         2 |          257 |          258 |  65 |  17 |  67
     111 |       0 |            3 |            1 |            4 |         3 |            1 |            1 |  66 |   1 |  68
     111 |       1 |            1 |            2 |            5 |         4 |          257 |          258 |  67 |  15 |  69
     111 |       0 |            2 |            3 |            1 |         5 |            1 |            1 |  78 |  16 |  80
     111 |       1 |            3 |            4 |            2 |         6 |          257 |          258 |  79 |  17 |  71
     111 |       0 |            1 |            1 |            3 |         1 |            1 |            1 |  80 |   1 |  72
     111 |       1 |            2 |            2 |            4 |         2 |          257 |          258 |  71 |  15 |  73
     111 |       0 |            3 |            3 |            5 |         3 |            1 |            1 |  72 |  16 |  74
     111 |       1 |            1 |            4 |            1 |         4 |          257 |          258 |  73 |  17 |  75
     111 |       0 |            2 |            1 |            2 |         5 |            1 |            1 |  74 |   1 |  76
     111 |       1 |            3 |            2 |            3 |         6 |          257 |          258 |  75 |  15 |  77
     111 |       0 |            1 |            3 |            4 |         1 |            1 |            1 |  76 |  16 |  78
     111 |       1 |            2 |            4 |            5 |         2 |          257 |          258 |  77 |  17 |  79
     111 |       0 |            3 |            1 |            1 |         3 |            1 |            1 |  88 |   1 |  90
     111 |       1 |            1 |            2 |            2 |         4 |          257 |          258 |  89 |  15 |  81
     111 |       0 |            2 |            3 |            3 |         5 |            1 |            1 |  90 |  16 |  82
     111 |       1 |            3 |            4 |            4 |         6 |          257 |          258 |  81 |  17 |  83
     111 |       0 |            1 |            1 |            5 |         1 |            1 |            1 |  82 |   1 |  84
     111 |       1 |            2 |            2 |            1 |         2 |          257 |          258 |  83 |  15 |  85
     111 |       0 |            3 |            3 |            2 |         3 |            1 |            1 |  84 |  16 |  86
     111 |       1 |            1 |            4 |            3 |         4 |          257 |          258 |  85 |  17 |  87
     111 |       0 |            2 |            1 |            4 |         5 |            1 |            1 |  86 |   1 |  88
     111 |       1 |            3 |            2 |            5 |         6 |          257 |          258 |  87 |  15 |  89
     111 |       0 |            1 |            3 |            1 |         1 |            1 |            1 |  98 |  16 | 100
     111 |       1 |            2 |            4 |            2 |         2 |          257 |          258 |  99 |  17 |  91
     111 |       0 |            3 |            1 |            3 |         3 |            1 |            1 | 100 |   1 |  92
     111 |       1 |            1 |            2 |            4 |         4 |          257 |          258 |  91 |  15 |  93
     111 |       0 |            2 |            3 |            5 |         5 |            1 |            1 |  92 |  16 |  94
     111 |       1 |            3 |            4 |            1 |         6 |          257 |          258 |  93 |  17 |  95
     111 |       0 |            1 |            1 |            2 |         1 |            1 |            1 |  94 |   1 |  96
     111 |       1 |            2 |            2 |            3 |         2 |          257 |          258 |  95 |  15 |  97
     111 |       0 |            3 |            3 |            4 |         3 |            1 |            1 |  96 |  16 |  98
     111 |       1 |            1 |            4 |            5 |         4 |          257 |          258 |  97 |  17 |  99
     111 |       0 |            2 |            1 |            1 |         5 |            1 |            1 | 108 |   1 | 110
     111 |       1 |            3 |            2 |            2 |         6 |          257 |          258 | 109 |  15 | 101
     111 |       0 |            1 |            3 |            3 |         1 |            1 |            1 | 110 |  16 | 102
     111 |       1 |            2 |            4 |            4 |         2 |          257 |          258 | 101 |  17 | 103
     111 |       0 |            3 |            1 |            5 |         3 |            1 |            1 | 102 |   1 | 104
     111 |       1 |            1 |            2 |            1 |         4 |          257 |          258 | 103 |  15 | 105
     111 |       0 |            2 |            3 |            2 |         5 |            1 |            1 | 104 |  16 | 106
     111 |       1 |            3 |            4 |            3 |         6 |          257 |          258 | 105 |  17 | 107
     111 |       0 |            1 |            1 |            4 |         1 |            1 |            1 | 106 |   1 | 108
     111 |       1 |            2 |            2 |            5 |         2 |          257 |          258 | 107 |  15 | 109
     111 |       0 |            3 |            3 |            1 |         3 |            1 |            1 | 118 |  16 | 120
     111 |       1 |            1 |            4 |            2 |         4 |          257 |          258 | 119 |  17 | 111
     111 |       0 |            2 |            1 |            3 |         5 |            1 |            1 | 120 |   1 | 112
     111 |       1 |            3 |            2 |            4 |         6 |          257 |          258 | 111 |  15 | 113
     111 |       0 |            1 |            3 |            5 |         1 |            1 |            1 | 112 |  16 | 114
     111 |       1 |            2 |            4 |            1 |         2 |          257 |          258 | 113 |  17 | 115
     111 |       0 |            3 |            1 |            2 |         3 |            1 |            1 | 114 |   1 | 116
     111 |       1 |            1 |            2 |            3 |         4 |          257 |          258 | 115 |  15 | 117
     111 |       0 |            2 |            3 |            4 |         5 |            1 |            1 | 116 |  16 | 118
     111 |       1 |            3 |            4 |            5 |         6 |          257 |          258 | 117 |  17 | 119
     111 |       0 |            1 |            1 |            1 |         1 |            1 |            1 | 128 |   1 | 130
     111 |       1 |            2 |            2 |            2 |         2 |          257 |          258 | 129 |  15 | 121
     111 |       0 |            3 |            3 |            3 |         3 |            1 |            1 | 130 |  16 | 122
     111 |       1 |            1 |            4 |            4 |         4 |          257 |          258 | 121 |  17 | 123
     111 |       0 |            2 |            1 |            5 |         5 |            1 |            1 | 122 |   1 | 124
     111 |       1 |            3 |            2 |            1 |         6 |          257 |          258 | 123 |  15 | 125
     111 |       0 |            1 |            3 |            2 |         1 |            1 |            1 | 124 |  16 | 126
     111 |       1 |            2 |            4 |            3 |         2 |          257 |          258 | 125 |  17 | 127
     111 |       0 |            3 |            1 |            4 |         3 |            1 |            1 | 126 |   1 | 128
     111 |       1 |            1 |            2 |            5 |         4 |          257 |          258 | 127 |  15 | 129
     111 |       0 |            2 |            3 |            1 |         5 |            1 |            1 | 138 |  16 | 140
     111 |       1 |            3 |            4 |            2 |         6 |          257 |          258 | 139 |  17 | 131
     111 |       0 |            1 |            1 |            3 |         1 |            1 |            1 | 140 |   1 | 132
     111 |       1 |            2 |            2 |            4 |         2 |          257 |          258 | 131 |  15 | 133
     111 |       0 |            3 |            3 |            5 |         3 |            1 |            1 | 132 |  16 | 134
     111 |       1 |            1 |            4 |            1 |         4 |          257 |          258 | 133 |  17 | 135
     111 |       0 |            2 |            1 |            2 |         5 |            1 |            1 | 134 |   1 | 136
     111 |       1 |            3 |            2 |            3 |         6 |          257 |          258 | 135 |  15 | 137
     111 |       0 |            1 |            3 |            4 |         1 |            1 |            1 | 136 |  16 | 138
     111 |       1 |            2 |            4 |            5 |         2 |          257 |          258 | 137 |  17 | 139
     111 |       0 |            3 |            1 |            1 |         3 |            1 |            1 | 148 |   1 | 150
     111 |       1 |            1 |            2 |            2 |         4 |          257 |          258 | 149 |  15 | 141
     111 |       0 |            2 |            3 |            3 |         5 |            1 |            1 | 150 |  16 | 142
     111 |       1 |            3 |            4 |            4 |         6 |          257 |          258 | 141 |  17 | 143
     111 |       0 |            1 |            1 |            5 |         1 |            1 |            1 | 142 |   1 | 144
     111 |       1 |            2 |            2 |            1 |         2 |          257 |          258 | 143 |  15 | 145
     111 |       0 |            3 |            3 |            2 |         3 |            1 |            1 | 144 |  16 | 146
     111 |       1 |            1 |            4 |            3 |         4 |          257 |          258 | 145 |  17 | 147
     111 |       0 |            2 |            1 |            4 |         5 |            1 |            1 | 146 |   1 | 148
     111 |       1 |            3 |            2 |            5 |         6 |          257 |          258 | 147 |  15 | 149
(150 rows)

DROP TABLE colcmpr_delta_nbits;
-- Problem:
-- when nbits is 64, assert clause failed. 2^64 cannot be represented by (1UL << 64)
-- Testcase:
-- 1. the diff is the max uplimits 0xffffffffffffffff
CREATE TABLE colcmpr_delta_nbits_01
(
	distKey INT8,
	a INT8,
	b INT8,
	c INT8
) with (orientation = orc) tablespace hdfs_ts  DISTRIBUTE BY HASH(distkey);
COPY colcmpr_delta_nbits_01 FROM '@abs_srcdir@/data/colcmpr_delta_nbits_01.data' delimiter '|';
SELECT * FROM colcmpr_delta_nbits_01;
 distkey | a  |  b   |          c           
---------+----+------+----------------------
       1 |  1 |    2 |                    0
       1 |  2 |  -23 |                  100
       1 | 10 |    1 |  9223372036854775807
       1 | 11 |  200 |                    3
       1 | 12 | -302 |                 -100
       1 | 13 |  322 |                 -200
       1 | 20 |    2 | -9223372036854775807
       1 | 21 |  100 |                    0
       1 | 22 | -200 |                  100
       1 | 23 |  -23 |                  -23
       1 | 30 |   -1 | -9223372036854775808
       1 | 31 |  900 |                  900
       1 |  1 |    2 |                    0
       1 |  2 |  -23 |                  100
       1 | 10 |    1 |  9223372036854775807
       1 | 11 |  200 |                    3
       1 | 12 | -302 |                 -100
       1 | 13 |  322 |                 -200
       1 | 20 |    2 | -9223372036854775807
       1 | 21 |  100 |                    0
       1 | 22 | -200 |                  100
       1 | 23 |  -23 |                  -23
       1 | 30 |   -1 | -9223372036854775808
       1 | 31 |  900 |                  900
       1 |  1 |    2 |                    0
       1 |  2 |  -23 |                  100
       1 | 10 |    1 |  9223372036854775807
       1 | 11 |  200 |                    3
       1 | 12 | -302 |                 -100
       1 | 13 |  322 |                 -200
       1 | 20 |    2 | -9223372036854775807
       1 | 21 |  100 |                    0
       1 | 22 | -200 |                  100
       1 | 23 |  -23 |                  -23
       1 | 30 |   -1 | -9223372036854775808
       1 | 31 |  900 |                  900
       1 |  1 |    2 |                    0
       1 |  2 |  -23 |                  100
       1 | 10 |    1 |  9223372036854775807
       1 | 11 |  200 |                    3
       1 | 12 | -302 |                 -100
       1 | 13 |  322 |                 -200
       1 | 20 |    2 | -9223372036854775807
       1 | 21 |  100 |                    0
       1 | 22 | -200 |                  100
       1 | 23 |  -23 |                  -23
       1 | 30 |   -1 | -9223372036854775808
       1 | 31 |  900 |                  900
       1 |  1 |    2 |                    0
       1 |  2 |  -23 |                  100
       1 | 10 |    1 |  9223372036854775807
       1 | 11 |  200 |                    3
       1 | 12 | -302 |                 -100
       1 | 13 |  322 |                 -200
       1 | 20 |    2 | -9223372036854775807
       1 | 21 |  100 |                    0
       1 | 22 | -200 |                  100
       1 | 23 |  -23 |                  -23
       1 | 30 |   -1 | -9223372036854775808
       1 | 31 |  900 |                  900
       1 |  1 |    2 |                    0
       1 |  2 |  -23 |                  100
       1 | 10 |    1 |  9223372036854775807
       1 | 11 |  200 |                    3
       1 | 12 | -302 |                 -100
       1 | 13 |  322 |                 -200
       1 | 20 |    2 | -9223372036854775807
       1 | 21 |  100 |                    0
       1 | 22 | -200 |                  100
       1 | 23 |  -23 |                  -23
       1 | 30 |   -1 | -9223372036854775808
       1 | 31 |  900 |                  900
       1 |  1 |    2 |                    0
       1 |  2 |  -23 |                  100
       1 | 10 |    1 |  9223372036854775807
       1 | 11 |  200 |                    3
       1 | 12 | -302 |                 -100
       1 | 13 |  322 |                 -200
       1 | 20 |    2 | -9223372036854775807
       1 | 21 |  100 |                    0
       1 | 22 | -200 |                  100
       1 | 23 |  -23 |                  -23
       1 | 30 |   -1 | -9223372036854775808
       1 | 31 |  900 |                  900
       1 |  1 |    2 |                    0
       1 |  2 |  -23 |                  100
       1 | 10 |    1 |  9223372036854775807
       1 | 11 |  200 |                    3
       1 | 12 | -302 |                 -100
       1 | 13 |  322 |                 -200
       1 | 20 |    2 | -9223372036854775807
       1 | 21 |  100 |                    0
       1 | 22 | -200 |                  100
       1 | 23 |  -23 |                  -23
       1 | 30 |   -1 | -9223372036854775808
       1 | 31 |  900 |                  900
(96 rows)

DROP TABLE colcmpr_delta_nbits_01;
